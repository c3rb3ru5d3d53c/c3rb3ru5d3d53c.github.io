<!doctype html><html lang=en dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Reversing Additional Lockbit 3.0 API Hashing | Malware Hell</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=https://c3rb3ru5d3d53c.github.io/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=https://c3rb3ru5d3d53c.github.io/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/bash.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/cpp.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/python.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/c.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/vbscript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/powershell.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/http.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/x86asm.min.js crossorigin></script>
<link rel=stylesheet href=https://c3rb3ru5d3d53c.github.io/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=https://c3rb3ru5d3d53c.github.io/js/fontawesome.min.9956a9fdeeb895bcca3e646ea4f943c9dfbabb5b76757ae1c2c3b3fe2ee29f21edf15c30e1b524d558b6363569a57b12.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=https://c3rb3ru5d3d53c.github.io/images/profile_hudffae30dddd93a90cdf89d35bb97314e_107726_32x32_fill_q75_box_center.jpg><link rel=apple-touch-icon sizes=180x180 href=https://c3rb3ru5d3d53c.github.io/images/profile_hudffae30dddd93a90cdf89d35bb97314e_107726_180x180_fill_q75_box_center.jpg><meta name=description content="Reversing an additional Lockbit 3.0 API hashing."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Malware Blog","item":"https://c3rb3ru5d3d53c.github.io/malware-blog/"},{"@type":"ListItem","position":2,"name":"Reversing Additional Lockbit 3.0 API Hashing","item":"https://c3rb3ru5d3d53c.github.io/malware-blog/lockbit-v3-api-hashing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://c3rb3ru5d3d53c.github.io/malware-blog/lockbit-v3-api-hashing/"},"headline":"Reversing Additional Lockbit 3.0 API Hashing | Malware Hell","datePublished":"2022-07-13T00:00:00+00:00","dateModified":"2022-07-13T00:00:00+00:00","wordCount":1398,"author":{"@type":"Person","name":"c3rb3ru5d3d53c"},"publisher":{"@type":"Person","name":"c3rb3ru5d3d53c","logo":{"@type":"ImageObject","url":"https://c3rb3ru5d3d53c.github.io/images/profile.jpg"}},"description":"Reversing an additional Lockbit 3.0 API hashing."}</script><meta property="og:title" content="Reversing Additional Lockbit 3.0 API Hashing | Malware Hell"><meta property="og:type" content="article"><meta property="og:image" content="https://c3rb3ru5d3d53c.github.io/images/profile.jpg"><meta property="og:url" content="https://c3rb3ru5d3d53c.github.io/malware-blog/lockbit-v3-api-hashing/"><meta property="og:description" content="Reversing an additional Lockbit 3.0 API hashing."><meta property="og:locale" content="en"><meta property="og:site_name" content="Malware Hell"><meta property="article:published_time" content="2022-07-13T00:00:00+00:00"><meta property="article:modified_time" content="2022-07-13T00:00:00+00:00"><meta property="article:section" content="malware-blog"><meta property="article:tag" content="lockbit"><meta property="article:tag" content="reversing"><meta property="article:tag" content="malware"><meta property="article:tag" content="analysis"><meta property="og:see_also" content="https://c3rb3ru5d3d53c.github.io/malware-blog/2022-07-04-bitter-apt-zxxz-backdoor/"><meta property="og:see_also" content="https://c3rb3ru5d3d53c.github.io/documents/deobfuscating-scripts/"><meta property="og:see_also" content="https://c3rb3ru5d3d53c.github.io/documents/malware-sample-handling/"><meta property="og:see_also" content="https://c3rb3ru5d3d53c.github.io/documents/malware-analysis-reversing-workflow/"><meta property="og:see_also" content="https://c3rb3ru5d3d53c.github.io/documents/cheatsheet/"><meta property="og:see_also" content="https://c3rb3ru5d3d53c.github.io/documents/malware-analysis-beginner-guide/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Malware Hell</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/malware-blog/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">Malware Blog</a>
<a href=/personal-blog/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">Personal Blog</a>
<a href=/iocs/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">IOCs</a>
<a href=https://github.com/c3rb3ru5d3d53c/signatures/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">Signatures</a>
<a href=/documents/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">Documents</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>Reversing Additional Lockbit 3.0 API Hashing</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2022-07-13</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>7 min read</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=https://c3rb3ru5d3d53c.github.io/categories/malware/ class=hover:text-eureka>malware</a></div></div><p>I was watching <a href=https://twitter.com/herrcore>@herrcore&rsquo;s</a> OALabs stream on Lockbit 3.0. After he wrote a utility to decrypt additional data from the ransomware, he noticed one of the buffers was a Portable Executable (PE) file. It had an interesting API hashing routine, we would be reversing for the next stream.</p><p>I decided to have a closer look. ðŸ˜„</p><h2 id=analysis>Analysis</h2><p>This is an interesting sample, I have not mapped out its full functionality yet.</p><p>However, I was able to get a decent amount of reversing done, which should give us more of an insight.</p><h3 id=tls-callback>TLS Callback</h3><p>Thread Local Storage (TLS) provides unique data for each thread, so the process can access it using a global index. It is possible with this functionality to store pointers to a TLS callback function in a PE header. The callback function pointers will then be executed before the actual entry point by Windows.</p><p>The TLS callback function in our case looks like this.</p><pre><code class=language-cpp>void tls_callback_0(PVOID DllHandle,DWORD dwReason) {
  if (dwReason == 1) {
    InitializeAPIs();  // Analyze Now
    TLSMain();         // TODO: Analyze Later
  }
  return;
}
</code></pre><p>For the purpose of this analysis, we are only interested in the function <em>InitializeAPIs</em>.</p><h3 id=api-hashing>API Hashing</h3><p>The main API hashing and resolving function will call <em>ResolveModule</em> to resolve a table of function pointers to be used later for each module. The first argument is a pointer to a DWORD hash table. This hash table starts with one DWORD hash to describe the DLL then a series of hashes to describe the functions for the module, ending with the DWORD <em>0x1a33acd5</em>, which acts as a delimiter denoting the end of the hash table for a given module.</p><pre><code class=language-cpp>void InitializeAPIs(void) {
  ntdll = (PFUNC_PTRS_0)ResolveModule((uint **)&amp;FUNC_HASHES_NTDLL,92);
  kernel32 = (PFUNC_PTRS_1)ResolveModule((uint **)&amp;FUNC_HASHES_KERNEL32,32);
  shell32 = (PFUNC_PTRS_2)ResolveModule((uint **)&amp;FUNC_HASHES_SHELL32,4);
  shlwapi = (PFUNC_PTRS_3)ResolveModule((uint **)&amp;FUNC_HASHES_SHLWAPI,12);
  wtsapi32 = (PFUNC_PTRS_4)ResolveModule((uint **)&amp;FUNC_HASHES_WTSAPI32,4);
  userenv = (PFUNC_PTRS_5)ResolveModule((uint **)&amp;FUNC_HASHES_USERENV,12);
  advapi32 = (PFUNC_PTRS_6)ResolveModule((uint **)&amp;FUNC_HASHES_ADVAPI32,48);
  netapi32 = (PFUNC_PTRS_7)ResolveModule((uint **)&amp;FUNC_HASHES_NETAPI32,8);
  return;
}
</code></pre><p>In order to allocate memory for the function pointer tables, it will resolve the API hash <em>0x90ad8283</em>, which is the function <em>ntdll.NtAllocateVirtualMemory</em>. It will allocate RegionSize based on how many functions are in the table. It will calculate the size by performing the bit shift operation <em>iFunctionCount &#171; 2</em>. This will ensure that each function pointer will be allocated 0x4 bytes of memory with <em>PAGE_EXECUTE_READWRITE</em> permissions.</p><p>It will then check the first hash to see if the DLL exists on the infected system by enumerating <em>C:\Windows\System32\*.dll</em>. In order to enumerate the directories, it resolves the following API hashes first.</p><table><thead><tr><th>Hash</th><th>Function</th></tr></thead><tbody><tr><td><em>0xaae0cefb</em></td><td>kernel32.FindFirstFileExW</td></tr><tr><td><em>0x63a1bff9</em></td><td>kernel32.FindNextFileW</td></tr><tr><td><em>0xe0979a4</em></td><td>kernel32.FindClose</td></tr></tbody></table><h4 id=module-hashing>Module Hashing</h4><p>The Dynamic Link Library (DLL) names are referenced by hash.</p><p>The function we are interested is as follows.</p><pre><code class=language-x86asm>0:  push   ebp
1:  mov    ebp,esp
3:  push   edx
4:  push   esi
5:  mov    edx,DWORD PTR [ebp+0xc]
8:  mov    eax,0x1e4c448d
d:  xor    eax,0x29009fe6
12: not    eax
14: xor    edx,eax
16: mov    esi,DWORD PTR [ebp+0x8]
19: xor    eax,eax
1b: lods   ax,WORD PTR ds:[esi]
1d: cmp    ax,0x41
21: jb     0x2d
23: cmp    ax,0x5a
27: ja     0x2d
29: or     ax,0x20
2d: add    dh,0x7a
30: sub    dh,0x7a
33: ror    edx,0xd
36: add    edx,eax
38: test   eax,eax
3a: jne    0x19
3c: mov    eax,edx
3e: pop    esi
3f: pop    edx
40: pop    ebp
41: ret    0x8
</code></pre><p>Interestingly, the following operations can be simplified for <em>eax</em>.</p><pre><code class=language-x86asm>8:  mov    eax,0x1e4c448d
d:  xor    eax,0x29009fe6
12: not    eax
</code></pre><p>The value of <em>eax</em> here is static and can be represented by <em>0xc8b32494</em> instead. It is important to note that in the binary there is a section where it performs a comparison but also modified the returned hash by performing the following.</p><pre><code class=language-x86asm>not Â  Â eax  
xor Â  Â eax,0x29009fe6  
cmp Â  Â eax,DWORD PTR [ebp+0x8]
</code></pre><p>This can be represented as <em>(~eax &0xffffffff) ^ 0x29009fe6</em>.</p><p>Now we can now recreate the functionality in Python.</p><pre><code class=language-python>def ror(n,rotations=1,width=32):
    return (2**width-1)&amp;(n&gt;&gt;rotations|n&lt;&lt;(width-rotations))

def hashstr(string, xmod):
    # Function 004010ec
    string = bytes(string, 'ascii') + b'\x00'
    result = 0xc8b32494 ^ xmod
    for c in string:
        if c &gt; 0x41 and c &lt; 0x5a: c = c | 0x20
        result = ror(result, rotations=0x0d, width=32)
        result += c
        if c == 0x00: break
    return result

result = (~hashstr('kernel32.dll', 0x00000000) &amp; 0xffffffff) ^ 0x29009fe6

print(hex(result))
</code></pre><p>Definitely an interesting hashing algorithm in how it has some redundant operations.</p><h4 id=function-hashing>Function Hashing</h4><p>The function name hashing takes into account the hash of the module as well.</p><pre><code class=language-python>def hash_fnc(string, mod_hash):
    # 004010b8
    string = bytes(string, 'ascii') + b'\x00'
    result = 0xc8b32494 ^ mod_hash
    for c in string:
        result = ror(result, rotations=0x0d, width=32)
        result += c
        if c == 0x00: break
    return result
</code></pre><p>This function reuses most of the same principles from the DLL hashing, except for performing an if statement on a range of characters.</p><h4 id=finalizing-hashes>Finalizing Hashes</h4><p>Throughout the code, it will finalize hashes with a <em>not</em> operation and an <em>XOR</em> operation against the constant <em>0x29009fe6</em>.</p><pre><code class=language-python>def hash_fin(fnc_hash):
    # Finalize Hash
    return (~fnc_hash &amp; 0xffffffff) ^ 0x29009fe6
</code></pre><p>We can even write a single function now to get the API hash based on the module name and exported function.</p><pre><code class=language-python>def hash_all(module, function, xmod):
    # Hash Module and Function
    return hash_fin(hash_fnc(function, hash_mod(module, xmod)))
</code></pre><p>Once the hash is finalized, it can be added to our hash table.</p><h4 id=hash-table>Hash Table</h4><p>The next step is for us to create a hash table, so we can easily resolve all the APIs.</p><pre><code class=language-python>import sys
import pefile
import pickle
from glob import glob
from pprint import pprint
from os.path import basename

# def ror(n,rotations=1,width=32)
# def hash_mod(string, xmod)
# def hash_fnc(string, mod_hash)
# def hash_fin(fnc_hash)
# def hash_all(module, function, xmod)

def get_exports(dll):
    pe = pefile.PE(dll)
    d = [pefile.DIRECTORY_ENTRY[&quot;IMAGE_DIRECTORY_ENTRY_EXPORT&quot;]]
    pe.parse_data_directories(directories=d)
    exports = []
    for export in pe.DIRECTORY_ENTRY_EXPORT.symbols:
        if export.name is not None: exports.append(export.name.decode())
    return list(set(exports))

dlls = glob('C:\Windows\System32\*.dll')

hashmap = {}

for dll in dlls:
    try:
        print('[-] ' + dll)
        exports = get_exports(dll)
        for export in exports:
            fnc_hash = hash_all(basename(dll), export, 0x00000000)
            fnc_name = basename(dll)[:-4] + '.' + export
            hashmap[fnc_hash] = fnc_name
            hashmap[hash_fin(hash_mod(basename(dll), 0x00000000))] = basename(dll)
        print('[+] ' + dll)
    except KeyboardInterrupt:
        pickle.dump(hashmap, open('hashmap.pickle', 'wb'), protocol=pickle.HIGHEST_PROTOCOL)
        sys.exit(0)
    except:
        pass

pickle.dump(hashmap, open('hashmap.pickle', 'wb'), protocol=pickle.HIGHEST_PROTOCOL)
</code></pre><p>This takes some time to run, but at the end we get a pickled Python dictionary or hash table we can use to resolve all the APIs we need. We can load the hash table by doing the following.</p><pre><code class=language-python>&gt;&gt; import pickle
&gt;&gt; h = pickle.load(open('hashmap.pickle', 'rb'))
&gt;&gt; h[0x2A9FB8E1]
'kernel32.dll'
&gt;&gt; h[0xAAE0CEFB]
'kernel32.FindFirstFileExW'
</code></pre><p>Here are some example API hashes for <em>kernel32</em>.</p><pre><code class=language-text>00401a64 e1 b8 9f 2a   DWORD    2A9FB8E1h            kernel32.dll
00401a68 fb ce e0 aa   DWORD    AAE0CEFBh            kernel32.FindFirstFileExW
00401a6c f9 bf a1 63   DWORD    63A1BFF9h            kernel32.FindNextFileW
00401a70 a4 79 09 0e   DWORD    E0979A4h             kernel32.FindClose
00401a74 c3 05 cc c7   DWORD    C7CC05C3h            kernel32.ExitProcess
00401a78 66 ae 26 8e   DWORD    8E26AE66h            kernel32.CopyFileW
00401a7c 22 22 47 d9   DWORD    D9472222h            kernel32.GetShortPathNameW
00401a80 9b f8 33 6d   DWORD    6D33F89Bh            kernel32.GetComputerNameW
00401a84 d5 5c 7f 3f   DWORD    3F7F5CD5h            kernel32.CreateNamedPipeW
00401a88 d5 ac 33 1a   DWORD    1A33ACD5h            HASH_DELIM
</code></pre><h3 id=string-decryption>String Decryption</h3><p>The cipher text for the strings are stored in the code section as double words that are moved to the data section. The address to the cipher text is pushed to the stack along with the number of double word iterations needed to perform the decryption. This makes the cipher text more challenging to extract. However, I was at least able to recreate the routine in Python, with a few tricks using checking the modulus of the data buffer length.</p><pre><code class=language-python>def decrypt_str(data):
    # 00401010
    data = bytes.fromhex(data)
    result = b''
    if (len(data) % 4)!= 0: return None
    for i in range(0, len(data), 4):
        dword = struct.unpack('&lt;I', data[i:i+4])[0]
        dword = (~(dword ^ 0x29009fe6) &amp; 0xffffffff)
        result += dword.to_bytes(4, byteorder='little')
    return result.decode('utf-16')
</code></pre><p>With this knowledge, we can now decrypt the following cipher text.</p><pre><code class=language-python>&gt;&gt; result = decrypt(b'\x45\x60\xD5\xD6\x37\x60\x9B\xD6\x75\x60\x93\xD6')
&gt;&gt; print(result)
\*.dll
</code></pre><h2 id=tls-main-function>TLS Main Function</h2><p>In order to obscure control flow, it will store function pointers to an encrypted VTable structure.</p><p>The pointer has a <em>not</em> operation performed on it, then it is <em>ror</em> by a random single byte. This is stored in the following data structure.</p><pre><code class=language-cpp>typedef struct _ENCRYPTED_VTABLE_ENTRY {
	DWORD EncryptedPointer; // VTable Encrypted Pointer
	USHORT Reserved0;       // Unknown
	BYTE RorSeed;           // RorSeed Key
	USHORT Reserved1;       // Unknown
	USHORT Reserved2;       // Unknown
} ENCRYPTED_VTABLE_ENTRY, *PENCRYPTED_VTABLE_ENTRY;
</code></pre><p>The encryption of just the pointer can be described as follows.</p><pre><code class=language-python>def ror(n,rotations=1,width=32):
    return (2**width-1)&amp;(n&gt;&gt;rotations|n&lt;&lt;(width-rotations))

def encrypt_ptr(data, key):
    return ror((~data &amp; 0xffffffff), rotations=key, width=
</code></pre><p>With this knowledge, we can perform the opposite operation <em>rol</em> to decrypt pointers.</p><pre><code class=language-python>def rol(n,rotations=1,width=32):
    return (2**width-1)&amp;(n&lt;&lt;rotations|n&gt;&gt;(width-rotations))

def decrypt_ptr(data, key):
    return rol((~data &amp; 0xffffffff), rotations=key, width=32)
</code></pre><p>I will continue to update this.</p><h2 id=downloads>Downloads</h2><ul><li><a href=assets/hashmap.zip>Hash Map</a></li><li><a href=https://gist.github.com/c3rb3ru5d3d53c/4f2c984d81ef64e5f133e37726619c64>Python Tool</a></li></ul></article><div class=my-4><a href=https://c3rb3ru5d3d53c.github.io/tags/lockbit/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#lockbit</a>
<a href=https://c3rb3ru5d3d53c.github.io/tags/reversing/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#reversing</a>
<a href=https://c3rb3ru5d3d53c.github.io/tags/malware/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#malware</a>
<a href=https://c3rb3ru5d3d53c.github.io/tags/analysis/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#analysis</a></div><div class=py-2><div class="my-8 flex flex-col items-center md:flex-row"><a href=https://c3rb3ru5d3d53c.github.io/authors/c3rb3ru5d3d53c/ class="md:me-4 text-primary-text h-24 w-24"><img src=https://c3rb3ru5d3d53c.github.io/images/profile.jpg class="bg-primary-bg w-full rounded-full" alt=Avatar></a><div class="mt-4 w-full md:mt-0 md:w-auto"><a href=https://c3rb3ru5d3d53c.github.io/authors/c3rb3ru5d3d53c/ class="mb-2 block border-b pb-1 text-lg font-bold"><h3>c3r3b3ru5d3d53c</h3></a><span class="block pb-2">I have acquired over my career, skills that make me a nightmare for threat actors.</span>
<a href=mailto:c3rb3ru5d3d53c@gmail.com class=me-2><i class="fas fa-envelope"></i></a>
<a href=https://twitter.com/c3rb3ru5d3d53c class=me-2><i class="fab fa-twitter"></i></a>
<a href=https://github.com/c3rb3ru5d3d53c class=me-2><i class="fab fa-github"></i></a>
<a href=https://www.youtube.com/channel/UCk9BugRahSWgPLYOAA3QH4w class=me-2><i class="fab fa-youtube"></i></a></div></div></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">Next</span>
<a href=https://c3rb3ru5d3d53c.github.io/malware-blog/2022-07-04-bitter-apt-zxxz-backdoor/ class=block>Making Fun of Your APT Malware - Bitter APT Using ZxxZ Backdoor to Target Pakistan Public Accounts Committee</a></div></div></div><div class=col-span-2><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>On This Page</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#analysis>Analysis</a><ul><li><a href=#tls-callback>TLS Callback</a></li><li><a href=#api-hashing>API Hashing</a><ul><li><a href=#module-hashing>Module Hashing</a></li><li><a href=#function-hashing>Function Hashing</a></li><li><a href=#finalizing-hashes>Finalizing Hashes</a></li><li><a href=#hash-table>Hash Table</a></li></ul></li><li><a href=#string-decryption>String Decryption</a></li></ul></li><li><a href=#tls-main-function>TLS Main Function</a></li><li><a href=#downloads>Downloads</a></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div><div class="bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>See Also</h3><a href=https://c3rb3ru5d3d53c.github.io/malware-blog/2022-07-04-bitter-apt-zxxz-backdoor/ class=no-underline>Making Fun of Your APT Malware - Bitter APT Using ZxxZ Backdoor to Target Pakistan Public Accounts Committee</a><br><a href=https://c3rb3ru5d3d53c.github.io/documents/deobfuscating-scripts/ class=no-underline>Deobfuscating Scripts</a><br><a href=https://c3rb3ru5d3d53c.github.io/documents/malware-sample-handling/ class=no-underline>Handling Malware Samples</a><br><a href=https://c3rb3ru5d3d53c.github.io/documents/malware-analysis-reversing-workflow/ class=no-underline>Malware Analysis and Reverse Engineering Workflow</a><br><a href=https://c3rb3ru5d3d53c.github.io/documents/cheatsheet/ class=no-underline>CheatSheet</a><br><a href=https://c3rb3ru5d3d53c.github.io/documents/malware-analysis-beginner-guide/ class=no-underline>Malware Analysis for Beginners</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2022 <a href=https://twitter.com/c3rb3ru5d3d53c>c3rb3ru5d3d53c</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>