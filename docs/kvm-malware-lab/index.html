<!doctype html><html lang=en dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>KVM Malware Lab Guide | Malware Hell</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=https://c3rb3ru5d3d53c.github.io/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=https://c3rb3ru5d3d53c.github.io/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/bash.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/cpp.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/python.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/c.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/vbscript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/powershell.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/http.min.js crossorigin></script>
<link rel=stylesheet href=https://c3rb3ru5d3d53c.github.io/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=https://c3rb3ru5d3d53c.github.io/js/fontawesome.min.9956a9fdeeb895bcca3e646ea4f943c9dfbabb5b76757ae1c2c3b3fe2ee29f21edf15c30e1b524d558b6363569a57b12.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=https://c3rb3ru5d3d53c.github.io/images/profile_hudffae30dddd93a90cdf89d35bb97314e_107726_32x32_fill_q75_box_center.jpg><link rel=apple-touch-icon sizes=180x180 href=https://c3rb3ru5d3d53c.github.io/images/profile_hudffae30dddd93a90cdf89d35bb97314e_107726_180x180_fill_q75_box_center.jpg><meta name=description content="How to create a KVM malware lab."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Documents","item":"https://c3rb3ru5d3d53c.github.io/docs/"},{"@type":"ListItem","position":2,"name":"KVM Malware Lab Guide","item":"https://c3rb3ru5d3d53c.github.io/docs/kvm-malware-lab/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://c3rb3ru5d3d53c.github.io/docs/kvm-malware-lab/"},"headline":"KVM Malware Lab Guide | Malware Hell","datePublished":"2022-06-18T00:00:00+00:00","dateModified":"2022-06-18T00:00:00+00:00","wordCount":1926,"author":{"@type":"Person","name":"c3rb3ru5d3d53c"},"publisher":{"@type":"Person","name":"c3rb3ru5d3d53c","logo":{"@type":"ImageObject","url":"https://c3rb3ru5d3d53c.github.io/images/profile.jpg"}},"description":"How to create a KVM malware lab."}</script><meta property="og:title" content="KVM Malware Lab Guide | Malware Hell"><meta property="og:type" content="article"><meta property="og:image" content="https://c3rb3ru5d3d53c.github.io/images/profile.jpg"><meta property="og:url" content="https://c3rb3ru5d3d53c.github.io/docs/kvm-malware-lab/"><meta property="og:description" content="How to create a KVM malware lab."><meta property="og:locale" content="en"><meta property="og:site_name" content="Malware Hell"><meta property="article:published_time" content="2022-06-18T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-18T00:00:00+00:00"><meta property="article:section" content="docs"><meta property="article:tag" content="kvm"><meta property="article:tag" content="malware"><meta property="article:tag" content="analysis"><meta property="article:tag" content="laboratory"><meta property="article:tag" content="lab"><meta property="article:tag" content="linux"><meta property="og:see_also" content="https://c3rb3ru5d3d53c.github.io/malware-blog/2020-02-12-qakbot-downloader/"><meta property="og:see_also" content="https://c3rb3ru5d3d53c.github.io/malware-blog/2020-02-10-vjw0rm-vipersoftx-variant/"><meta property="og:see_also" content="https://c3rb3ru5d3d53c.github.io/malware-blog/2020-02-01-vjw0rm-mr-robot-variant/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Malware Hell</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/malware-blog/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">Malware Blog</a>
<a href=/personal-blog/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">Personal Blog</a>
<a href=/iocs/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">IOCs</a>
<a href=https://github.com/c3rb3ru5d3d53c/signatures/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">Signatures</a>
<a href=/docs/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">Documents</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class=lg:pt-12><div class="flex flex-col md:flex-row bg-secondary-bg rounded"><div class="md:w-1/4 lg:w-1/5 border-e"><div class="sticky top-16 pt-6"><div id=sidebar-title class="md:hidden mx-4 px-2 pt-4 pb-2 md:border-b text-tertiary-text md:text-primary-text"><span class=font-semibold>Table of Contents</span>
<i class='fas fa-caret-right ms-1'></i></div><div id=sidebar-toc class="hidden md:block overflow-y-auto mx-6 md:mx-0 pe-6 pt-2 md:max-h-doc-sidebar bg-primary-bg md:bg-transparent"><div class="flex flex-wrap ms-4 -me-2 p-2 bg-secondary-bg md:bg-primary-bg rounded"><a class="text-eureka hover:text-eureka" href=https://c3rb3ru5d3d53c.github.io/docs/kvm-malware-lab/>KVM Malware Lab Guide</a></div><ul class=ps-6></ul></div></div></div><div class="w-full md:w-3/4 lg:w-4/5 pb-8 pt-2 md:pt-8"><div class=flex><div class="w-full lg:w-3/4 px-6"><article class=prose><h1 class=mb-4>KVM Malware Lab Guide</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2022-06-18</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>10 min read</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=https://c3rb3ru5d3d53c.github.io/categories/malware/ class=hover:text-eureka>malware</a></div></div><p>This is my guide for setting up your very own malware lab using KVM.</p><p>Before you start, this guide assumes you have an <a href=https://airvpn.org/>AirVPN</a> subscription or another equivalent one, which provides a <strong>.ovpn</strong> file.</p><p><em>NOTE: I like to have internet enabled on my analysis VMs and this comes with extra security considerations and potential risk if you do not perform the setup correctly. It is recommended that you have your KVM host machine on a DMZ. Most home routers do have DMZ settings, just consult your manual. This guide is not intended for beginners.</em></p><p>If you have used VirtualBox or VMWare Workstation in the past, Spice is just like the guest tools for these but for KVM, which allows you to copy/paste and copy samples to your VMs from your host machine.</p><p>Once this guide is completed, you should have networking that looks like this:</p><pre><code class=language-text>  ┌────────┐
  │Internet│
  └───┬────┘
      │
┌─────┴──────┐
│Host Machine│ Kernel Virtual Machine (KVM) on DMZ
└─────┬──────┘
      │
    ┌─┴─┐
    │NAT│ (default)
    └─┬─┘
      │
  ┌───┴───┐ ┌────────┐
  │PFSense├─┤Isolated│ LAN 10.0.1.1/24 (vmbr0)
  └───────┘ └───┬────┘
                │
             ┌──┴───┐
             │Remnux│ Static Analysis and Interception
             └──┬───┘
                │
            ┌───┴────┐
            │Isolated│ Analysis LAN 10.0.2.1/24 (vmbr1)
            └─┬──────┤
              │      │
      ┌───────┴───┐ ┌┴──────┐
      │Analysis VM│ │Windows│ Dynamic Analysis
      └───────────┘ └───────┘
</code></pre><h2 id=install-kvm>Install KVM</h2><p>This section of the guide will show you how to install KVM on your Linux host.</p><ul><li>Verify you have virtualization enabled</li></ul><pre><code class=language-bash>grep -Po '(vmx|svm)[^\x20]+' /proc/cpuinfo | sort | uniq
</code></pre><ul><li>If there is any output from the previous command then virtualization is enabled, otherwise, enable it in your bios and try again</li><li>Install dependencies</li></ul><pre><code class=language-bash>sudo apt update
sudo apt install -y virt-manager qemu-kvm build-essential python-is-python3
</code></pre><ul><li>Verify that <strong>libvirtd</strong> service is running</li></ul><pre><code class=language-bash>sudo systemctl enable libvirtd
sudo systemctl start libvirtd
</code></pre><ul><li>Add current user to the <strong>libvirt</strong> group</li></ul><pre><code class=language-bash>sudo usermod -a -G libvirt $USER
</code></pre><ul><li>Install modified version of <a href=https://www.seabios.org/SeaBIOS>SeaBios</a> (modifies <strong>src/config.h</strong> to more realistic values)</li></ul><pre><code class=language-bash>git clone https://github.com/c3rb3ru5d3d53c/seabios.git
cd seabios/
make
sudo cp /usr/share/seabios/bios.bin /usr/share/seabios/bios.bin.bak
sudo cp out/bios.bin /usr/share/seabios/bios.bin
</code></pre><ul><li>Once all has been completed do a reboot</li></ul><pre><code class=language-bash>sudo reboot
</code></pre><h2 id=create-vms>Create VMS</h2><p>This section will guide you through the creation of the malware lab with KVM using <strong>virt-manager</strong>.</p><h3 id=create-virtual-networks>Create Virtual Networks</h3><ul><li>Edit -> Connection Details -> + -> <strong>vmbr0</strong> Isolated (PFSense LAN)<ul><li>Disable both IPV4 and IPv6 (Provided by PFSense)</li></ul></li><li>Edit -> Connection Details -> + -> <strong>vmbr1</strong> Isolated (Analysis LAN)<ul><li>Disable both IPV4 and IPv6 (Provided by Remnux)</li></ul></li></ul><h3 id=create-pfsense-vm>Create PFSense VM</h3><p>The primary purpose of the PFSense VM is to provide an easy way to manage firewall rules between your home or work network and the internet. I know most people disable their internet when analyzing malware. However, I like to use an anonymous VPN and with that comes additional risk and considerations.</p><iframe width=560 height=315 src=https://www.youtube.com/embed/DKD--Egx39Q title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><ul><li>Download: <a href=https://www.pfsense.org/download/>https://www.pfsense.org/download/</a></li><li>Create <strong>qcow2</strong> image:</li></ul><pre><code class=language-bash>qemu-img create -f qcow2 pfsense.qcow2 16G
</code></pre><ul><li>Create a new virtual machine<ul><li>Import Existing Disk Image</li><li>Select <strong>pfsense.qcow2</strong> as the storage path</li><li>Select FreeBSD as the OS</li><li>Name: <strong>pfsense</strong></li><li>Customize configuration before install</li><li>Set first NIC to NAT</li><li>Add Hardware -> Network -> vmbr0 (PFSense Network)</li><li>Add Hardware -> Network -> CDROM Device -> Manager -> PFSense ISO</li><li>Boot Options -> Set CDROM device as first in boot order</li></ul></li><li>Start the VM</li><li>Set LAN as <strong>10.0.1.1/24</strong> in PFSense setup</li></ul><h3 id=create-remnux-vm-ubuntu-2204>Create Remnux VM (Ubuntu 22.04)</h3><p>The primary purpose of this VM is to allow you to perform static analysis of binaries using IDA, Ghidra or Cutter but also acts as the gateway for your entire analysis subnet. This gives you full control over the DNS and DHCP server for traffic interception and more.</p><p><em>NOTE: The official <strong>remnux</strong> distribution OS is quite outdated, to solve this it is recommended to use the latest LTS image from Ubuntu as the VM and instead use <strong>remnux</strong> within that VM as a container.</em></p><iframe width=560 height=315 src=https://www.youtube.com/embed/3LMU7IRQYHI title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><ul><li>Download <a href=https://releases.ubuntu.com/22.04/>https://releases.ubuntu.com/22.04/</a></li><li>Create the disk image</li></ul><pre><code class=language-bash>qemu-img create -f qcow2 remnux.qcow2 40G
</code></pre><ul><li>Create a new virtual machine<ul><li>Import existing disk image</li><li>Select <strong>remnux.qcow2</strong> as the storage path</li><li>Select Ubuntu as the OS</li><li>Name: <strong>remnux</strong></li><li>Customize configuration before install</li><li>Set first NIC to <strong>vmbr0</strong> (PFSense Network)</li><li>Add Hardware -> Network -> <strong>vmbr1</strong> (Analysis Network)</li><li>Add Hardware -> Storage -> CDROM Device-> Manage -> Ubuntu ISO Image</li><li>Boot Options -> Set CDROM device as first in boot order</li></ul></li><li>Start VM</li><li>Install dependancies</li></ul><pre><code class=language-bash>sudo apt update
sudo apt install dnsmasq isc-dhcp-server openvpn docker.io spice-vdagent
sudo systemctl enable spice-vdagent
sudo systemctl enable docker
sudo usermod -a -G docker $USER
# logout and login again
</code></pre><ul><li>Create your <strong>remnux</strong> docker container</li></ul><pre><code class=language-bash>docker run --rm -it -v $(pwd):$HOME -u remnux remnux/remnux-distro:focal bash
</code></pre><ul><li>Set up the interfaces</li></ul><pre><code class=language-bash>sudo nano /etc/netplan/01-network-manager-all.yaml
# Replace it with the following contents
: 'network:
  version: 2
  renderer: networkd
  ethernets:
    enp1s0:
      dhcp4: yes
    enp7s0:
      addresses:
        - 10.0.2.1/24
'
</code></pre><ul><li>Disable <strong>dnsmasq</strong> conflicts with <strong>systemd-resolved</strong></li></ul><pre><code class=language-bash>sudo nano /etc/systemd/resolved.conf
# Append DNSStubListener=no to the end of the file and save
sudo systemctl restart systemd-resolved
sudo systemctl enable dnsmasq
sudo systemctl restart dnsmasq
</code></pre><ul><li>Setup the dhcp server</li></ul><pre><code class=language-bash>sudo nano /etc/dhcp/dhcpd.conf
# Add the following content to the configuration
: 'subnet 10.0.2.0 netmask 255.255.255.0 {
   option domain-name &quot;malware.wtf&quot;;
   default-lease-time 600;
   max-lease-time 7200;
   option routers 10.0.2.1;
   option subnet-mask 255.255.255.0;
   option broadcast-address 10.0.2.255;
   option domain-name-servers 10.0.2.1;
   range 10.0.2.2 10.0.2.254;
}'
sudo systemctl enable isc-dhcp-server
sudo systemctl restart isc-dhcp-server
</code></pre><ul><li>Browse to <strong>https://10.0.1.1</strong> and login with <strong>admin:pfsense</strong> and setup your own password for PFSense.<ul><li>Add firewall rules to block your local network, in my case it was to block everything from <strong>LAN net</strong> to <strong>192.168.0.1/24</strong>.</li><li>Apply the changes</li></ul></li><li>Setup internet forwarding</li></ul><pre><code class=language-bash>sudo iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE
sudo apt install iptables-persistent # Say yes to both prompts
sudo nano /etc/sysctl.conf # Uncomment the line with net.ipv4.ip_forward=1
sudo sysctl -w net.ipv4.ip_forward=1
</code></pre><ul><li>Create a script to allow to you start your VPN</li></ul><pre><code class=language-bash>nano vpn.sh
# Add the following contents and save
: '
#!/usr/bin/env bash
openvpn --daemon --config AirVPN_All-servers_UDP-443.ovpn
'
chmod +x vpn.sh
sudo ./vpn.sh
</code></pre><ul><li>Setup TLS Decryption with MITMProxy</li></ul><pre><code class=language-bash>sudo apt update
sudo apt install -y wireshark tshark # Say yes to non-super user packet capture
sudo usermod -a -G wireshark $USER   # logout then login again
wget https://snapshots.mitmproxy.org/8.1.0/mitmproxy-8.1.0-linux.tar.gz
tar -xzvf mitmproxy-8.1.0-linux.tar.gz
sudo mv mitmdump /usr/bin/
sudo mv mitmproxy /usr/bin/
sudo mv mitmweb /usr/bin/
wget https://gist.githubusercontent.com/c3rb3ru5d3d53c/d9eb9d752882fcc630d338a6b2461777/raw/f56cbef4b98c7bad8f265534eabf696923b649a2/mitmpcap
chmod +x mitmpcap
sudo mv mitmpcap /usr/bin/
wget https://gist.githubusercontent.com/c3rb3ru5d3d53c/3bc8041a182467ccae0207394c1e16b3/raw/33bf201da721ae8f8dc057480221a3c6612e7c11/mitmhttp
chmod +x mitmhttp
sudo mv mitmhttp /usr/bin/
sudo mkdir /root/.mitmproxy
</code></pre><p>Once completed, you should be able to reboot and run <strong>sudo ./vpn.sh</strong> to get connected to the internet. <em>NOTE: The internet will not work on the Analysis LAN unless you have VPN enabled as we set the internet to be forwarded through <strong>tun0</strong> for <strong>openvpn</strong>.</em> This is a good thing, this means it will force you to use an anonymous VPN and reduce risk of leaking your actual IP address.</p><h3 id=create-windows-vm>Create Windows VM</h3><p>This VM will sit on the Analysis LAN, its main purpose is to dynamically analyze malware by executing it. This includes debugging, tracing API calls and more.</p><p><em>NOTE: With a Windows VM it is very important to ensure your boot drive is using the VirtIO drivers.</em></p><iframe width=560 height=315 src=https://www.youtube.com/embed/xc6hviPzMK0 title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><ul><li>Download <a href=https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso>VirtIO ISO</a></li><li>Create disk image</li></ul><pre><code class=language-bash>qemu-img create -f qcow2 windows.qcow2 128G
</code></pre><ul><li>Create a new virtual machine<ul><li>Import existing disk image</li><li>Select <strong>windows.qcow2</strong> as the storage path</li><li>Select Windows as the OS</li><li>Name: <strong>windows</strong></li><li>Customize configuration before install</li><li>Set first NIC to <strong>vmbr1</strong> (Analysis LAN)</li><li>Add Hardware -> Storage -> CDROM Device-> Manage -> Windows ISO Image</li><li>Add Hardware -> Storage CDROM Device -> Manage -> VirtIO ISO</li><li>Boot Options -> Set CDROM device for Windows ISO to boot first</li><li>Remove the SATA Disk and replace with one for VirtIO pointing to <strong>windows.qcow2</strong></li><li>Start installation</li></ul></li><li>During the Windows install the VirtIO disk will not show unless you browse to the VirtIO ISO and select the folder with the drivers for your version of Windows. Once completed, you can proceed with the installation.</li><li>Once Windows is installed, open Device Manager and identify all the drivers with question marks and update them using the VirtIO ISO CDROM.</li><li>Download and install <a href=https://www.spice-space.org/download/windows/spice-guest-tools/spice-guest-tools-latest.exe>Spice Guest Tools</a></li><li>Reboot the VM</li></ul><p>If you are unable to boot using the VirtIO driver, try the following troubleshooting steps:</p><ul><li>Open an elevated command prompt and set the VM to boot into safe mode by typing<ul><li><strong><em>bcdedit /set {current} safeboot minimal</em></strong></li></ul></li><li>shut-down the VM and change the boot device type to virtio</li><li>boot the VM. It will enter in safe mode.</li><li>in the booted VM reset the bcdedit settings to allow the machine to boot into the Normal mode by typing (in an elevated command prompt again):<ul><li><strong><em>bcdedit /deletevalue {current} safeboot</em></strong></li></ul></li></ul><p>Reference: <a href=https://superuser.com/questions/1057959/windows-10-in-kvm-change-boot-disk-to-virtio>Windows 10 in KVM: change boot disk to Virtio</a></p><p>Once you have completed all necessary steps, it is recommended to remove the CDROM drive for the VirtIO drivers.</p><h2 id=installing-tls-decryption-certificates>Installing TLS Decryption Certificates</h2><p>This section of the guide will discuss how to get TLS decryption working on your Remnux VM so you can transparently decrypt TLS and capture secrets and pcaps from the analysis network as long as the devices have the root CA installed.</p><iframe width=560 height=315 src=https://www.youtube.com/embed/CAzEG4QwQkk title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><ul><li>On your Remnux machine do the following commands</li></ul><pre><code class=language-bash>sudo mitmhttp -i &lt;analysis-network-interface&gt; --enable
mitmproxy --mode transparent --listen-host 0.0.0.0 --listen-port 8080
</code></pre><ul><li>On your Windows VM open a browser and go to <strong>mitm.it</strong> then follow either the Manual or Automated install instructions<ul><li>Manual Install<ul><li>On the webpage download the certificate for Windows</li><li>Double click the P12 file to start the import wizard</li><li>Select a certificate store location. This determines who will trust the certificate – only the current Windows user or everyone on the machine. Click Next.</li><li>Click Next again</li><li>Leave Password blank and click Next</li><li>Select Place all certificates in the following store, then click Browse, and select Trusted Root Certification Authorities. Click OK and Next</li><li>Click Finish</li><li>Click Yes to confirm the warning dialog.</li></ul></li><li>Automated Install<ul><li><strong>certutil.exe -addstore root mitmproxy-ca-cert.cer</strong></li></ul></li><li>In your browser visit <a href=https://example.com>https://example.com</a> to verify a successful decryption in the mitmproxy interface</li></ul></li></ul><p>If the above steps were successful, you can now use the tool mitmpcap to view traffic live with mitmproxy but also use it to capture TLS secrets and a pcap for analysis later.</p><pre><code class=language-bash>mitmpcap -i enp7s0 -w dump.pcap -m transparent -p 8080 -s secrets.txt -v 1 -f libpcap
</code></pre><p>Once you have finished your capture, press <strong>Q</strong> then <strong>Y</strong> to exit mitmproxy. You should then notice you have the files <strong>dump.pcap</strong> and <strong>secrets.txt</strong>. The following steps will show you how to use Wireshark to analyze your capture.</p><ul><li>Open <strong>dump.pcap</strong> with Wireshark</li><li>Edit -> Preferences -> Protocols -> TLS -> (Pre)-Master-Secret log filename Browse -> select <strong>secrets.txt</strong></li><li>In the filter bar type <strong>http</strong> and press <strong>Enter</strong></li><li>You should now have decrypted TLS traffic</li></ul><p>Once you have completed capturing your traffic and no longer wish to perform interception, disable the redirection by executing the following.</p><pre><code class=language-bash>sudo mitmhttp -i &lt;analysis-network-interface&gt; --disable
</code></pre><h2 id=install-malware-analysis-tools>Install Malware Analysis Tools</h2><p>Once you have completed the networking and VM creation, you can install your favorite malware analysis tools!</p><p>You can get a list of my favorite tools <a href=/docs/malware-analysis-tools/>here</a>.</p><h2 id=establishing-a-clean-environment>Establishing a Clean Environment</h2><p>Once you have completed installing your favorite tools, establish a clean environment by taking snapshots of every VM. This will ensure you can go back to those clean states after you have completed an analysis.</p><h2 id=conclusion>Conclusion</h2><p>Once you have the PFSense and Remnux VMs setup, you can create additional VMs on your Analysis LAN to suit your needs.</p><p>Creating a malware lab using KVM can be a daunting task for beginners compared to using VMWare Workstation or VirtualBox. However, it can benefit your lab in the following ways.</p><ul><li>Access to source code you can edit to make your VMs super stealthy</li><li>CPU Emulated VMs (MIPS, ARM, etc.) for IoT malware</li><li>PCI pass through of hardware</li></ul><p>Again I cannot recommend KVM enough, it is great for malware analysis!</p></article><div class=my-4><a href=https://c3rb3ru5d3d53c.github.io/tags/kvm/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#kvm</a>
<a href=https://c3rb3ru5d3d53c.github.io/tags/malware/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#malware</a>
<a href=https://c3rb3ru5d3d53c.github.io/tags/analysis/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#analysis</a>
<a href=https://c3rb3ru5d3d53c.github.io/tags/laboratory/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#laboratory</a>
<a href=https://c3rb3ru5d3d53c.github.io/tags/lab/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#lab</a>
<a href=https://c3rb3ru5d3d53c.github.io/tags/linux/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#linux</a></div><div class=py-2><div class="my-8 flex flex-col items-center md:flex-row"><a href=https://c3rb3ru5d3d53c.github.io/authors/c3rb3ru5d3d53c/ class="md:me-4 text-primary-text h-24 w-24"><img src=https://c3rb3ru5d3d53c.github.io/images/profile.jpg class="bg-primary-bg w-full rounded-full" alt=Avatar></a><div class="mt-4 w-full md:mt-0 md:w-auto"><a href=https://c3rb3ru5d3d53c.github.io/authors/c3rb3ru5d3d53c/ class="mb-2 block border-b pb-1 text-lg font-bold"><h3>c3r3b3ru5d3d53c</h3></a><span class="block pb-2">I have acquired over my career, skills that make me a nightmare for threat actors.</span>
<a href=mailto:c3rb3ru5d3d53c@gmail.com class=me-2><i class="fas fa-envelope"></i></a>
<a href=https://twitter.com/c3rb3ru5d3d53c class=me-2><i class="fab fa-twitter"></i></a>
<a href=https://github.com/c3rb3ru5d3d53c class=me-2><i class="fab fa-github"></i></a>
<a href=https://www.youtube.com/channel/UCk9BugRahSWgPLYOAA3QH4w class=me-2><i class="fab fa-youtube"></i></a></div></div></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div><span class="text-primary-text block font-bold">Previous</span>
<a href=https://c3rb3ru5d3d53c.github.io/docs/malware-analysis-beginner-guide/ class=block>Malware Analysis for Beginners</a></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">Next</span>
<a href=https://c3rb3ru5d3d53c.github.io/docs/malware-analysis-tools/ class=block>Malware Analysis Tool List</a></div></div></div><div class="hidden lg:block lg:w-1/4"><div class="bg-secondary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>On This Page</h3></div><div class="sticky-toc
border-s
hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#install-kvm>Install KVM</a></li><li><a href=#create-vms>Create VMS</a><ul><li><a href=#create-virtual-networks>Create Virtual Networks</a></li><li><a href=#create-pfsense-vm>Create PFSense VM</a></li><li><a href=#create-remnux-vm-ubuntu-2204>Create Remnux VM (Ubuntu 22.04)</a></li><li><a href=#create-windows-vm>Create Windows VM</a></li></ul></li><li><a href=#installing-tls-decryption-certificates>Installing TLS Decryption Certificates</a></li><li><a href=#install-malware-analysis-tools>Install Malware Analysis Tools</a></li><li><a href=#establishing-a-clean-environment>Establishing a Clean Environment</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div></div></div></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll(),changeSidebarHeight(),switchDocToc()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2022 <a href=https://twitter.com/c3rb3ru5d3d53c>c3rb3ru5d3d53c</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>