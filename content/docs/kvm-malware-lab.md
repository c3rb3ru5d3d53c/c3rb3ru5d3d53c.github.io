---
title: KVM Malware Lab Guide
description: How to create a KVM malware lab.
toc: true
authors: c3rb3ru5d3d53c
tags:
  - kvm
  - malware
  - analysis
  - laboratory
  - lab
  - linux
categories: malware
series:
date: '2022-06-17'
lastmod: '2022-06-17'
draft: false
---

# KVM Configuration
This is my guide for setting up your very own malware lab using KVM.

Before you start, this guide assumes you have an [AirVPN](https://airvpn.org/) subscription.

*NOTE: I like to have internet enabled on my analysis VMs and this comes with extra security considerations and potential risk if you do not perform the setup correcty. This guide is not intended for beginners.*

## Terminology
| Term                | Definition                                  |
| ------------------- | ------------------------------------------- |
| `spice-vdagent`       | Linux Agent for (Copy/Paste/Screen-Resize)  |
| `Spice Guest Tools`   | Windows Agent for (Copy/Pate/Screen-Resize) |
| `KVM`                 | Kernel Virtual Machine                      |

If you have used VirtualBox or VMWare Workstation in the past, Spice is just like the guest tools for these but for KVM.

## Install KVM
This section of the guide will show you how to install KVM on your linux host.
- Verify you have virtualization enabled
```bash
grep -Po '(vmx|svm)[^\x20]+' /proc/cpuinfo | sort | uniq
```
- If any output from previous command virtualization is enabled, otherwise, enable in your bios and try again
- Install dependencies
```bash
sudo apt update
sudo apt install -y virt-manager qemu-kvm
```
- Verify that `libvirtd` service is running
```bash
sudo systemctl enable libvirtd
sudo systemctl start libvirtd
```
- Add current user to the `libvirt` group
```bash
sudo usermod -a -G libvirt $USER
```
- Once all has been completed do a reboot
```bash
sudo reboot
```
## Create VMS
This section will guide you through the creation of the malware lab with KVM using `virt-manager`.

### Create Virtual Networks
- Edit -> Connection Details -> + -> `vmbr1` Isolated (PFSense LAN)
	- IPv4 only
	- `10.0.1.1/24`
- Edit -> Connection Details -> + -> `vmb2` Isolated (Analysis LAN)
	- IPv4 Only
	- `10.0.2.1/24`

### Create PFSense VM
The primary purpose of the PFSense VM is to provide an easy way to manage firewall rules between your home or work network and the internet. I know most people disable their internet when analyzing malware, however  I like to use anonymous VPN and with that comes additional risk and considerations.
- Download: https://www.pfsense.org/download/
- Create `qcow2` image:
```bash
qemu-img create -f qcow2 pfsense.qcow2 16G
```
- Create a new virtual machine
- Import Existing Disk Image
- Use `pfsense.qcow2` image for storage
- Add CDROM for PFSense ISO and set first in boot order
- Edit -> Connection Details -> + -> `vmbr0` Isolated (Uncheck IPv4 and IPv6)
- Start the VM
- Set LAN as `10.0.1.1/24` in PFSense setup

### Create Remnux VM (Ubuntu 22.04)
The primary purpose of this VM is to allow you to perform static analysis of binaries using IDA, Ghidra or Cutter but also acts as the gateway for your entire analysis subnet. This gives you full control over the DNS and DHCP server for traffic interception and more. *NOTE: The offical `remnux` distribution OS is quite outdated, to solve this it is recommended latest LTS image from Ubuntu as the VM and instead use `remnux` within that VM as a container.*
- Download https://releases.ubuntu.com/22.04/
- Create the disk image
```bash
qemu-img create -f qcow2 remnux.qcow2 40G
```
- Create a new virtual machine
	- Import existing disk image
	- Select `remnux.qcow2` as the storage path
	- Select Ubuntu as the OS
	- Name: `remnux`
	- Customize configuration before install
	- Set first NIC to `vmbr0` (PFSense Network)
	- Add Hardware -> Network -> `vmbr1` (Analysis Network)
	- Add Hardware -> Storage -> CDROM Device-> Manage -> Ubuntu ISO Image
	- Boot Options -> Set CDROM device as first in boot order
- Start VM
- Install dependancies
```bash
sudo apt update
sudo apt install dnsmasq isc-dhcp-server openvpn docker.io spice-vdagent
sudo systemctl enabled spice-vdagent
sudo usermod -a -G docker $USER
# logout and login again
```
- Create your `remnux` docker container
```bash
docker run --rm -it -v (pwd):$HOME -u remnux remnux/remnux-distro:focal bash
```
- Set-up the interfaces
```bash
sudo nano /etc/netplan/01-network-manager-all.yaml
# Replace it with the following contents
: 'network:
  version: 2
  renderer: networkd
  ethernets:
    enp1s0:
      dhcp4: yes
    enp7s0:
      addresses:
        - 10.0.2.1/24
'
```
- Disable `dnsmasq` conflicts with `systemd-resolved`
```bash
sudo nano /etc/systemd/resolved.conf
# Append DNSStubListener=no to the end of the file and save
sudo systemctl restart systemd-resolved
sudo systemctl enable dnsmasq
sudo systemctl restart dnsmasq
```
- Setup the dhcp server
```bash
sudo nano /etc/dhcp/dhcpd.conf
# Add the following content to the configuration
: 'subnet 10.0.2.0 netmask 255.255.255.0 {
   option domain-name "malware.wtf";
   default-lease-time 600;
   max-lease-time 7200;
   option routers 10.0.2.1;
   option subnet-mask 255.255.255.0;
   option broadcast-address 10.0.2.255;
   option domain-name-servers 10.0.2.1;
   range 10.0.2.2 10.0.2.254;
}'
sudo systemctl enable isc-dhcp-server
sudo systemctl restart isc-dhcp-server
```
- Browse to `https://10.0.1.1` and login with `admin:pfsense` and setup your own password for PFSense.
	- Add firewall rules to block your local network, in my case it was to block everything from `LAN net` to `192.168.0.1/24`.
	- Apply the changes
- Setup internet forwarding
```bash
sudo iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE
sudo apt install iptables-persistent # Say yes to both prompts
sudo nano /etc/sysctl.conf # Uncomment the line with net.ipv4.ip_forward=1
sudo sysctl -w net.ipv4.ip_forward=1
```
- Create a script to allow to you start your VPN
```bash
nano vpn.sh
# Add the following contents and save
: '
#!/usr/bin/env bash
openvpn --daemon --config AirVPN_All-servers_UDP-443.ovpn
'
chmod +x vpn.sh
sudo ./vpn.sh
```

Once completed, you should be able to reboot and run `sudo ./vpn.sh` to get connected to the internet. *NOTE: The internet will not work on the Analysis LAN unless you have VPN enabled as we set the internet to be forwarded through `tun0` for `openvpn`.* This is a good thing, this means it will for you to use anonymous VPN and reduce risk of leaking your actual IP address.

### Create Windows VM
This VM will sit on the Analysis LAN, its main purpose is to dynamicly analyze malware by executing it. This includes debugging, tracing API calls and more.

- Download [VirtIO ISO](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso)
- Create disk image
```bash
qemu-img create -f qcow2 windows.qcow2 128G
```
 - Create a new virtual machine
	- Import existing disk image
	- Select `windows.qcow2` as the storage path
	- Select Windows as the OS
	- Name: `windows`
	- Customize configuration before install
	- Set first NIC to `vmbr1` (Analysis LAN)
	- Add Hardware -> Storage -> CDROM Device-> Manage -> Windows ISO Image
	- Add Hardware -> Storage CDROM Device -> Manage -> VirtIO ISO
	- Boot Options -> Set CDROM device for Windows ISO to boot first
	- Remove the SATA Disk and replace with one for VirtIO pointing tot `windows.qcow2`
	- Start installation
- During the Windows install the VirtIO disk will now show unless you browse to the VirtIO ISO and select the folder with the drivers for your version of Windows. Once completed, you can proceed with the install.
- Once Windows is installed, open Device Manager and identify all the drivers with question marks and update them using the VirtIO ISO CDROM.
- Download and install [Spice Guest Tools](https://www.spice-space.org/download/windows/spice-guest-tools/spice-guest-tools-latest.exe)
- Reboot the VM

Once completed, you can install your favorite malware analysis tools!

## Conclusion
Once you have the PFSense and Remnux VMs setup, you can create additional VMs on your Analysis LAN to suit your needs.

Creating a malware lab using KVM can be a daunting task for beginners compared to using VMWare Workstation or VirtualBox. However, it can benifit your lab in the following ways.

- Access to source code you can edit to make your VMs super stealthy
- CPU Emulated VMs (MIPS, ARM, etc.) for IoT malware
- PCI pass through of hardware

Again I cannot recommend KVM enough, it is great for malware analysis!
