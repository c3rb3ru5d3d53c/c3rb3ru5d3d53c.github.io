---
title: KVM Malware Lab Guide
description: How to create a KVM malware lab.
toc: true
authors: c3rb3ru5d3d53c
tags:
  - kvm
  - malware
  - analysis
  - laboratory
  - lab
  - linux
categories: malware
series:
date: '2022-06-18'
draft: false
---

This is my guide for setting up your very own malware lab using KVM.

Before you start, this guide assumes you have an [AirVPN](https://airvpn.org/) subscription or another equivelent one, which provides a __.ovpn__ file.

*NOTE: I like to have internet enabled on my analysis VMs and this comes with extra security considerations and potential risk if you do not perform the setup correcty. This guide is not intended for beginners.*

If you have used VirtualBox or VMWare Workstation in the past, Spice is just like the guest tools for these but for KVM, which allows you to copy/paste and copy samples to your VMs from your host machine.

Once this guide is completed, you should have networking that looks like this:

```text
  ┌────────┐
  │Internet│
  └───┬────┘
      │
┌─────┴──────┐
│Host Machine│ Kernel Virtual Machine (KVM)
└─────┬──────┘
      │
    ┌─┴─┐
    │NAT│ (default)
    └─┬─┘
      │
  ┌───┴───┐ ┌────────┐
  │PFSense├─┤Isolated│ LAN 10.0.1.1/24 (vmbr0)
  └───────┘ └───┬────┘
                │
             ┌──┴───┐
             │Remnux│ Static Analysis and Interception
             └──┬───┘
                │
            ┌───┴────┐
            │Isolated│ Analysis LAN 10.0.2.1/24 (vmbr1)
            └─┬──────┤
              │      │
      ┌───────┴───┐ ┌┴──────┐
      │Analysis VM│ │Windows│ Dynamic Analysis
      └───────────┘ └───────┘
```

## Install KVM
This section of the guide will show you how to install KVM on your linux host.
- Verify you have virtualization enabled
```bash
grep -Po '(vmx|svm)[^\x20]+' /proc/cpuinfo | sort | uniq
```
- If any output from previous command virtualization is enabled, otherwise, enable in your bios and try again
- Install dependencies
```bash
sudo apt update
sudo apt install -y virt-manager qemu-kvm build-essential python-is-python3
```
- Verify that __libvirtd__ service is running
```bash
sudo systemctl enable libvirtd
sudo systemctl start libvirtd
```
- Add current user to the __libvirt__ group
```bash
sudo usermod -a -G libvirt $USER
```
- Install modified version of [SeaBios](https://www.seabios.org/SeaBIOS) (modifies __src/config.h__ to more realistic values)
```bash
git clone https://github.com/c3rb3ru5d3d53c/seabios.git
cd seabios/
make
sudo cp /usr/share/seabios/bios.bin /usr/share/seabios/bios.bin.bak
sudo cp out/bios.bin /usr/share/seabios/bios.bin
```
- Once all has been completed do a reboot
```bash
sudo reboot
```
## Create VMS
This section will guide you through the creation of the malware lab with KVM using __virt-manager__.

### Create Virtual Networks
- Edit -> Connection Details -> + -> __vmbr0__ Isolated (PFSense LAN)
	- Disable both IPV4 and IPv6 (Provided by PFSense)
- Edit -> Connection Details -> + -> __vmbr1__ Isolated (Analysis LAN)
	- Disable both IPV4 and IPv6 (Provided by Remnux)

### Create PFSense VM
The primary purpose of the PFSense VM is to provide an easy way to manage firewall rules between your home or work network and the internet. I know most people disable their internet when analyzing malware, however  I like to use anonymous VPN and with that comes additional risk and considerations.
- Download: https://www.pfsense.org/download/
- Create __qcow2__ image:
```bash
qemu-img create -f qcow2 pfsense.qcow2 16G
```
- Create a new virtual machine
	- Import Existing Disk Image
	- Use __pfsense.qcow2__ image for storage
	- Add CDROM for PFSense ISO and set first in boot order
	- Edit -> Connection Details -> + -> __vmbr0__ Isolated (Uncheck IPv4 and IPv6)
- Start the VM
- Set LAN as __10.0.1.1/24__ in PFSense setup

### Create Remnux VM (Ubuntu 22.04)
The primary purpose of this VM is to allow you to perform static analysis of binaries using IDA, Ghidra or Cutter but also acts as the gateway for your entire analysis subnet. This gives you full control over the DNS and DHCP server for traffic interception and more. 

*NOTE: The offical __remnux__ distribution OS is quite outdated, to solve this it is recommended latest LTS image from Ubuntu as the VM and instead use __remnux__ within that VM as a container.*
- Download https://releases.ubuntu.com/22.04/
- Create the disk image
```bash
qemu-img create -f qcow2 remnux.qcow2 40G
```
- Create a new virtual machine
	- Import existing disk image
	- Select __remnux.qcow2__ as the storage path
	- Select Ubuntu as the OS
	- Name: __remnux__
	- Customize configuration before install
	- Set first NIC to __vmbr0__ (PFSense Network)
	- Add Hardware -> Network -> __vmbr1__ (Analysis Network)
	- Add Hardware -> Storage -> CDROM Device-> Manage -> Ubuntu ISO Image
	- Boot Options -> Set CDROM device as first in boot order
- Start VM
- Install dependancies
```bash
sudo apt update
sudo apt install dnsmasq isc-dhcp-server openvpn docker.io spice-vdagent
sudo systemctl enable spice-vdagent
sudo systemctl enable docker
sudo usermod -a -G docker $USER
# logout and login again
```
- Create your __remnux__ docker container
```bash
docker run --rm -it -v (pwd):$HOME -u remnux remnux/remnux-distro:focal bash
```
- Set-up the interfaces
```bash
sudo nano /etc/netplan/01-network-manager-all.yaml
# Replace it with the following contents
: 'network:
  version: 2
  renderer: networkd
  ethernets:
    enp1s0:
      dhcp4: yes
    enp7s0:
      addresses:
        - 10.0.2.1/24
'
```
- Disable __dnsmasq__ conflicts with __systemd-resolved__
```bash
sudo nano /etc/systemd/resolved.conf
# Append DNSStubListener=no to the end of the file and save
sudo systemctl restart systemd-resolved
sudo systemctl enable dnsmasq
sudo systemctl restart dnsmasq
```
- Setup the dhcp server
```bash
sudo nano /etc/dhcp/dhcpd.conf
# Add the following content to the configuration
: 'subnet 10.0.2.0 netmask 255.255.255.0 {
   option domain-name "malware.wtf";
   default-lease-time 600;
   max-lease-time 7200;
   option routers 10.0.2.1;
   option subnet-mask 255.255.255.0;
   option broadcast-address 10.0.2.255;
   option domain-name-servers 10.0.2.1;
   range 10.0.2.2 10.0.2.254;
}'
sudo systemctl enable isc-dhcp-server
sudo systemctl restart isc-dhcp-server
```
- Browse to __https://10.0.1.1__ and login with __admin:pfsense__ and setup your own password for PFSense.
	- Add firewall rules to block your local network, in my case it was to block everything from __LAN net__ to __192.168.0.1/24__.
	- Apply the changes
- Setup internet forwarding
```bash
sudo iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE
sudo apt install iptables-persistent # Say yes to both prompts
sudo nano /etc/sysctl.conf # Uncomment the line with net.ipv4.ip_forward=1
sudo sysctl -w net.ipv4.ip_forward=1
```
- Create a script to allow to you start your VPN
```bash
nano vpn.sh
# Add the following contents and save
: '
#!/usr/bin/env bash
openvpn --daemon --config AirVPN_All-servers_UDP-443.ovpn
'
chmod +x vpn.sh
sudo ./vpn.sh
```
- Setup TLS Decryption with MITMProxy
```bash
sudo apt update
sudo apt install -y wireshark tshark # Say yes to non-super user packet capture
sudo usermod -a -G wireshark $USER   # logout then login again
wget https://snapshots.mitmproxy.org/8.1.0/mitmproxy-8.1.0-linux.tar.gz
tar -xzvf mitmproxy-8.1.0-linux.tar.gz
sudo mv mitmdump /usr/bin/
sudo mv mitmproxy /usr/bin/
sudo mv mitmweb /usr/bin/
wget https://gist.githubusercontent.com/c3rb3ru5d3d53c/d9eb9d752882fcc630d338a6b2461777/raw/f56cbef4b98c7bad8f265534eabf696923b649a2/mitmpcap
chmod +x mitmpcap
sudo mv mitmpcap /usr/bin/
wget https://gist.githubusercontent.com/c3rb3ru5d3d53c/3bc8041a182467ccae0207394c1e16b3/raw/33bf201da721ae8f8dc057480221a3c6612e7c11/mitmhttp
chmod +x mitmhttp
sudo mv mitmhttp /usr/bin/
```

Once completed, you should be able to reboot and run __sudo ./vpn.sh__ to get connected to the internet. *NOTE: The internet will not work on the Analysis LAN unless you have VPN enabled as we set the internet to be forwarded through __tun0__ for __openvpn__.* This is a good thing, this means it will for you to use anonymous VPN and reduce risk of leaking your actual IP address.

### Create Windows VM
This VM will sit on the Analysis LAN, its main purpose is to dynamicly analyze malware by executing it. This includes debugging, tracing API calls and more.

NOTE: With  a Windows VM  it is very important to ensure your boot drive is using the VirtIO drivers.

- Download [VirtIO ISO](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso)
- Create disk image
```bash
qemu-img create -f qcow2 windows.qcow2 128G
```
 - Create a new virtual machine
	- Import existing disk image
	- Select __windows.qcow2__ as the storage path
	- Select Windows as the OS
	- Name: __windows__
	- Customize configuration before install
	- Set first NIC to __vmbr1__ (Analysis LAN)
	- Add Hardware -> Storage -> CDROM Device-> Manage -> Windows ISO Image
	- Add Hardware -> Storage CDROM Device -> Manage -> VirtIO ISO
	- Boot Options -> Set CDROM device for Windows ISO to boot first
	- Remove the SATA Disk and replace with one for VirtIO pointing tot __windows.qcow2__
	- Start installation
- During the Windows install the VirtIO disk will now show unless you browse to the VirtIO ISO and select the folder with the drivers for your version of Windows. Once completed, you can proceed with the install.
- Once Windows is installed, open Device Manager and identify all the drivers with question marks and update them using the VirtIO ISO CDROM.
- Download and install [Spice Guest Tools](https://www.spice-space.org/download/windows/spice-guest-tools/spice-guest-tools-latest.exe)
- Reboot the VM

If you are unable to boot using the VirtIO driver, try the following troubleshooting steps:
- Open an elevated command prompt and set the VM to boot into safe mode by typing
	- **_bcdedit /set {current} safeboot minimal_**
- shut-down the VM and change the boot device type to virtio
- boot the VM. It will enter in safe mode.
- in the booted VM reset the bcdedit settings to allow the machine to boot into the Normal mode by typing (in elevated command prompt again):
	- **_bcdedit /deletevalue {current} safeboot_**

Reference: [Windows 10 in KVM: change boot disk to Virtio](https://superuser.com/questions/1057959/windows-10-in-kvm-change-boot-disk-to-virtio)

Once you have completed all nessassary steps, it is recommened to remove the CDROM drive for the VirtIO drivers.

## Installing TLS Decryption Certificates
This secttion of the guide will discuss how to get TLS decryption working on your Remnux VM so you can transparently decrypt TLS and capture secrets and pcaps from the analysis network as long as the devices have the root CA installed.

- On your Remnux machine do the following commands
```bash
sudo mitmhttp -i <analysis-network-interface> --enable
mitmproxy --mode transparent --listen-host 0.0.0.0 --listen-port 8080
```
- On your Windows VM open a browser and goto __mitm.it__ then follow either the Manual or Automated install instructions
	- Manual Install
		- One the webpage download the certificate for Windows
		- Double click the P12 file to start the import wizard
		- Select a certificate store location. This determines who will trust the certificate – only the current Windows user or everyone on the machine. Click Next.
		- Click Next again
		- Leave Password blank and click Next
		- Select Place all certificates in the following store, then click Browse, and select Trusted Root Certification Authorities. Click OK and Next
		- Click Finish
		- Click Yes to confirm the warning dialog.
	- Automated Install
		- __certutil.exe -addstore root mitmproxy-ca-cert.cer__
	- In your browser visit https://example.com to verify a successful decryption in the mitmproxy interface

If the above steps were successful, you can now use the tool mitmpcap to view traffic live with mitmproxy but also use it to capture TLS secrets and a pcap for analysis later.

```bash
mitmpcap -i enp7s0 -w dump.pcap -m transparent -p 8080 -s secrets.txt -v 1 -f libpcap
```

Once you have finished your capture, press __Q__ then __Y__ to exit mitmproxy. You should then notice you have the files __dump.pcap__ and __secrets.txt__. The following steps will show you how to use Wireshark to analyze your capture.

- Open __dump.pcap__ with Wireshark
- Edit -> Preferences -> Protocols -> TLS -> (Pre)-Master-Secret log filename Browse -> select __secrets.txt__
- In the filter bar type __http__ and press __Enter__
- You should now have decrypted TLS traffic

Once you have completed capturing your traffic and no longer wish to perform interception, disable the redirection by executing the following.

```bash
sudo mitmhttp -i <analysis-network-interface> --disable
```

## Install Malware Analysis Tools
Once you have completed the networking and VM creation, you can install your favorite malware analysis tools!

You can get a list of my favorite tools [here](/docs/malware-analysis-tools/).

## Establishing a Clean Environment

Once you have completed installing your favorite tools, establish a clean enviornment by taking snapshots of every VM. This will  ensure you can go back to those clean states after you have completed an analysis.

## Conclusion
Once you have the PFSense and Remnux VMs setup, you can create additional VMs on your Analysis LAN to suit your needs.

Creating a malware lab using KVM can be a daunting task for beginners compared to using VMWare Workstation or VirtualBox. However, it can benifit your lab in the following ways.

- Access to source code you can edit to make your VMs super stealthy
- CPU Emulated VMs (MIPS, ARM, etc.) for IoT malware
- PCI pass through of hardware

Again I cannot recommend KVM enough, it is great for malware analysis!
