<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>KVM Malware Lab Guide - Malware Hell</title><meta name=Description content="How to create a KVM malware lab."><meta property="og:title" content="KVM Malware Lab Guide">
<meta property="og:description" content="How to create a KVM malware lab."><meta property="og:type" content="article"><meta property="og:url" content="https://c3rb3r3u5d3d53c.github.io/2022/06/kvm-malware-lab/"><meta property="og:image" content="https://c3rb3r3u5d3d53c.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-18T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-18T00:00:00+00:00"><meta property="og:site_name" content="Malware Hell"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://c3rb3r3u5d3d53c.github.io/logo.png"><meta name=twitter:title content="KVM Malware Lab Guide"><meta name=twitter:description content="How to create a KVM malware lab."><meta name=twitter:site content="@c3rb3ru5d3d53c"><meta name=application-name content="Malware Hell"><meta name=apple-mobile-web-app-title content="Malware Hell"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://c3rb3r3u5d3d53c.github.io/2022/06/kvm-malware-lab/><link rel=prev href=https://c3rb3r3u5d3d53c.github.io/2022/06/malware-analysis-tools/><link rel=next href=https://c3rb3r3u5d3d53c.github.io/2022/06/career/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"KVM Malware Lab Guide","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/c3rb3r3u5d3d53c.github.io\/2022\/06\/kvm-malware-lab\/"},"genre":"posts","keywords":"Cheatsheet","wordcount":2654,"url":"https:\/\/c3rb3r3u5d3d53c.github.io\/2022\/06\/kvm-malware-lab\/","datePublished":"2022-06-18T00:00:00+00:00","dateModified":"2022-06-18T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"c3rb3ru5d3d53c"},"description":"How to create a KVM malware lab."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Malware Hell"><span class=header-title-pre><i class='fa-solid fa-terminal' aria-hidden=true></i></span><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=Blog><i class="fa-solid fa-square-pen"></i> </a><a class=menu-item href=/tags/ title=Tags><i class="fa-solid fa-tag"></i> </a><a class=menu-item href=/categories/ title=Categories><i class="fa-solid fa-folder"></i> </a><a class=menu-item href=https://discord.gg/NzaXGDVYkD title="Discord Server" rel="noopener noreffer" target=_blank><i class="fa-brands fa-discord"></i> <i class="fa-solid fa-server"></i></a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Malware Hell"><span class=header-title-pre><i class='fa-solid fa-terminal' aria-hidden=true></i></span><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title=Blog><i class="fa-solid fa-square-pen"></i></a><a class=menu-item href=/tags/ title=Tags><i class="fa-solid fa-tag"></i></a><a class=menu-item href=/categories/ title=Categories><i class="fa-solid fa-folder"></i></a><a class=menu-item href=https://discord.gg/NzaXGDVYkD title="Discord Server" rel="noopener noreffer" target=_blank><i class="fa-brands fa-discord"></i><i class="fa-solid fa-server"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">KVM Malware Lab Guide</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://c3rb3ru5d3d53c.github.io title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>c3rb3ru5d3d53c</a></span>&nbsp;<span class=post-category>included in <a href=/categories/docs/><i class="far fa-folder fa-fw" aria-hidden=true></i>Docs</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-06-18>2022-06-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2654 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;13 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#install-kvm>Install KVM</a></li><li><a href=#create-vms>Create VMS</a><ul><li><a href=#create-virtual-networks>Create Virtual Networks</a></li><li><a href=#create-pfsense-vm>Create PFSense VM</a></li><li><a href=#create-remnux-vm-ubuntu-2204>Create Remnux VM (Ubuntu 22.04)</a></li><li><a href=#create-windows-vm>Create Windows VM</a></li></ul></li><li><a href=#installing-tls-decryption-certificates>Installing TLS Decryption Certificates</a></li><li><a href=#install-malware-analysis-tools>Install Malware Analysis Tools</a></li><li><a href=#establishing-a-clean-environment>Establishing a Clean Environment</a></li><li><a href=#sharing-files-between-host-and-remnux-vm>Sharing Files Between Host and Remnux VM</a></li><li><a href=#forwarding-ports>Forwarding Ports</a><ul><li><a href=#host-to-guest>Host to Guest</a></li><li><a href=#guest-to-host>Guest to Host</a></li></ul></li><li><a href=#workflow>Workflow</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div><div class=content id=content><p>This is my guide for setting up your very own malware lab using KVM.</p><p>Before you start, this guide assumes you have an <a href=https://airvpn.org/ target=_blank rel="noopener noreffer">AirVPN</a> subscription or another equivalent one, which provides a <strong>.ovpn</strong> file.</p><blockquote><p>NOTE: I like to have internet enabled on my analysis VMs and this comes with extra security considerations and potential risk if you do not perform the setup correctly. It is recommended that you have your KVM host machine on a DMZ. Most home routers do have DMZ settings, just consult your manual. This guide is not intended for beginners.</p></blockquote><p>If you have used VirtualBox or VMWare Workstation in the past, Spice is just like the guest tools for these but for KVM, which allows you to copy/paste and copy samples to your VMs from your host machine.</p><blockquote><p>NOTE: This is not a very stealthy setup as of yet, so do expect some malware to detect your VMs. I will continue to update this guide for stealth once I have a server or workstation. This requires forking the qemu code and modifying it.</p></blockquote><p>Once this guide is completed, you should have networking that looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  ┌────────┐
</span></span><span class=line><span class=cl>  │Internet│
</span></span><span class=line><span class=cl>  └───┬────┘
</span></span><span class=line><span class=cl>      │
</span></span><span class=line><span class=cl>┌─────┴──────┐
</span></span><span class=line><span class=cl>│Host Machine│ Kernel Virtual Machine (KVM) on DMZ
</span></span><span class=line><span class=cl>└─────┬──────┘
</span></span><span class=line><span class=cl>      │
</span></span><span class=line><span class=cl>    ┌─┴─┐
</span></span><span class=line><span class=cl>    │NAT│ (default)
</span></span><span class=line><span class=cl>    └─┬─┘
</span></span><span class=line><span class=cl>      │
</span></span><span class=line><span class=cl>  ┌───┴───┐ ┌────────┐
</span></span><span class=line><span class=cl>  │PFSense├─┤Isolated│ LAN 10.0.1.1/24 (vmbr0)
</span></span><span class=line><span class=cl>  └───────┘ └───┬────┘
</span></span><span class=line><span class=cl>                │
</span></span><span class=line><span class=cl>             ┌──┴───┐
</span></span><span class=line><span class=cl>             │Remnux│ Static Analysis and Interception
</span></span><span class=line><span class=cl>             └──┬───┘
</span></span><span class=line><span class=cl>                │
</span></span><span class=line><span class=cl>            ┌───┴────┐
</span></span><span class=line><span class=cl>            │Isolated│ Analysis LAN 10.0.2.1/24 (vmbr1)
</span></span><span class=line><span class=cl>            └─┬──────┤
</span></span><span class=line><span class=cl>              │      │
</span></span><span class=line><span class=cl>      ┌───────┴───┐ ┌┴──────┐
</span></span><span class=line><span class=cl>      │Analysis VM│ │Windows│ Dynamic Analysis
</span></span><span class=line><span class=cl>      └───────────┘ └───────┘
</span></span></code></pre></td></tr></table></div></div><h2 id=install-kvm>Install KVM</h2><p>This section of the guide will show you how to install KVM on your Linux host.</p><iframe width=560 height=315 src=https://www.youtube.com/embed/Epfr-uWZMiw title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><ul><li>Verify you have virtualization enabled</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>grep -Po <span class=s1>&#39;(vmx|svm)[^\x20]+&#39;</span> /proc/cpuinfo <span class=p>|</span> sort <span class=p>|</span> uniq <span class=c1># For Host Machine</span>
</span></span><span class=line><span class=cl>cat /sys/module/kvm_intel/parameters/nested              <span class=c1># Nested Virtualization Only (intel)</span>
</span></span><span class=line><span class=cl>cat /sys/module/kvm_amd/parameters/nested                <span class=c1># Nested Virtualization Only (amd)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Enable Nested Virtualization (optional)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano /etc/modprobe.d/kvm.conf <span class=c1># Nested Virtualization Configuration File</span>
</span></span><span class=line><span class=cl><span class=c1># Add the following configuration</span>
</span></span><span class=line><span class=cl>: <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>options kvm_intel nested=1
</span></span></span><span class=line><span class=cl><span class=s1>&#39;</span> <span class=c1># save then reboot</span>
</span></span><span class=line><span class=cl>sudo reboot
</span></span></code></pre></td></tr></table></div></div><ul><li>If there is any output from the previous command then virtualization is enabled, otherwise, enable it in your bios and try again
<em>NOTE: Using nested virtualization will come with significant performance costs, it is much more advisable to use Linux with KVM on bare metal</em></li><li>Install dependencies</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install -y virt-manager qemu-kvm build-essential python-is-python3
</span></span></code></pre></td></tr></table></div></div><ul><li>Verify that <strong>libvirtd</strong> service is running</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> libvirtd
</span></span><span class=line><span class=cl>sudo systemctl start libvirtd
</span></span></code></pre></td></tr></table></div></div><ul><li>Add current user to the <strong>libvirt</strong> group</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo usermod -a -G libvirt <span class=nv>$USER</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Install modified version of <a href=https://www.seabios.org/SeaBIOS target=_blank rel="noopener noreffer">SeaBios</a> (modifies <strong>src/config.h</strong> to more realistic values)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/c3rb3ru5d3d53c/seabios.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> seabios/
</span></span><span class=line><span class=cl>make
</span></span><span class=line><span class=cl>sudo cp /usr/share/seabios/bios.bin /usr/share/seabios/bios.bin.bak
</span></span><span class=line><span class=cl>sudo cp out/bios.bin /usr/share/seabios/bios.bin
</span></span></code></pre></td></tr></table></div></div><ul><li>If you want <strong>virt-manager</strong> to be able to access your home directory, you may need to set upstream permissions (this step is optional)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo setfacl -m u:libvirt-qemu:rx /home/<span class=nv>$USER</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Once all has been completed do a reboot</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo reboot
</span></span></code></pre></td></tr></table></div></div><h2 id=create-vms>Create VMS</h2><p>This section will guide you through the creation of the malware lab with KVM using <strong>virt-manager</strong>.</p><h3 id=create-virtual-networks>Create Virtual Networks</h3><ul><li>Edit -> Connection Details -> + -> <strong>vmbr0</strong> Isolated (PFSense LAN)<ul><li>Disable both IPV4 and IPv6 (Provided by PFSense)</li></ul></li><li>Edit -> Connection Details -> + -> <strong>vmbr1</strong> Isolated (Analysis LAN)<ul><li>Disable both IPV4 and IPv6 (Provided by Remnux)</li></ul></li></ul><h3 id=create-pfsense-vm>Create PFSense VM</h3><p>The primary purpose of the PFSense VM is to provide an easy way to manage firewall rules between your home or work network and the internet. I know most people disable their internet when analyzing malware. However, I like to use an anonymous VPN and with that comes additional risk and considerations.</p><iframe width=560 height=315 src=https://www.youtube.com/embed/DKD--Egx39Q title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><ul><li>Download: <a href=https://www.pfsense.org/download/ target=_blank rel="noopener noreffer">https://www.pfsense.org/download/</a></li><li>Create <strong>qcow2</strong> image:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qemu-img create -f qcow2 pfsense.qcow2 16G
</span></span></code></pre></td></tr></table></div></div><ul><li>Create a new virtual machine<ul><li>Import Existing Disk Image</li><li>Select <strong>pfsense.qcow2</strong> as the storage path</li><li>Select FreeBSD as the OS</li><li>Name: <strong>pfsense</strong></li><li>Customize configuration before install</li><li>Set first NIC to NAT</li><li>Add Hardware -> Network -> vmbr0 (PFSense Network)</li><li>Add Hardware -> Network -> CDROM Device -> Manager -> PFSense ISO</li><li>Boot Options -> Set CDROM device as first in boot order</li></ul></li><li>Start the VM</li><li>Set LAN as <strong>10.0.1.1/24</strong> in PFSense setup</li></ul><h3 id=create-remnux-vm-ubuntu-2204>Create Remnux VM (Ubuntu 22.04)</h3><p>The primary purpose of this VM is to allow you to perform static analysis of binaries using IDA, Ghidra or Cutter but also acts as the gateway for your entire analysis subnet. This gives you full control over the DNS and DHCP server for traffic interception and more.</p><p><em>NOTE: The official <strong>remnux</strong> distribution OS is quite outdated, to solve this it is recommended to use the latest LTS image from Ubuntu as the VM and instead use <strong>remnux</strong> within that VM as a container.</em></p><iframe width=560 height=315 src=https://www.youtube.com/embed/3LMU7IRQYHI title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><ul><li>Download <a href=https://releases.ubuntu.com/22.04/ target=_blank rel="noopener noreffer">https://releases.ubuntu.com/22.04/</a></li><li>Create the disk image</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qemu-img create -f qcow2 remnux.qcow2 40G
</span></span></code></pre></td></tr></table></div></div><ul><li>Create a new virtual machine<ul><li>Import existing disk image</li><li>Select <strong>remnux.qcow2</strong> as the storage path</li><li>Select Ubuntu as the OS</li><li>Name: <strong>remnux</strong></li><li>Customize configuration before install</li><li>Set first NIC to <strong>vmbr0</strong> (PFSense Network)</li><li>Add Hardware -> Network -> <strong>vmbr1</strong> (Analysis Network)</li><li>Add Hardware -> Storage -> CDROM Device-> Manage -> Ubuntu ISO Image</li><li>Boot Options -> Set CDROM device as first in boot order</li></ul></li><li>Start VM</li><li>Install dependancies</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install dnsmasq isc-dhcp-server openvpn docker.io spice-vdagent
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> spice-vdagent
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> docker
</span></span><span class=line><span class=cl>sudo usermod -a -G docker <span class=nv>$USER</span>
</span></span><span class=line><span class=cl><span class=c1># logout and login again</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Create your <strong>remnux</strong> docker container</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --rm -it -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>:<span class=nv>$HOME</span> -u remnux remnux/remnux-distro:focal bash
</span></span></code></pre></td></tr></table></div></div><ul><li>Set up the interfaces</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano /etc/netplan/01-network-manager-all.yaml
</span></span><span class=line><span class=cl><span class=c1># Replace it with the following contents</span>
</span></span><span class=line><span class=cl>: <span class=s1>&#39;network:
</span></span></span><span class=line><span class=cl><span class=s1>  version: 2
</span></span></span><span class=line><span class=cl><span class=s1>  renderer: networkd
</span></span></span><span class=line><span class=cl><span class=s1>  ethernets:
</span></span></span><span class=line><span class=cl><span class=s1>    enp1s0:
</span></span></span><span class=line><span class=cl><span class=s1>      dhcp4: yes
</span></span></span><span class=line><span class=cl><span class=s1>    enp7s0:
</span></span></span><span class=line><span class=cl><span class=s1>      addresses:
</span></span></span><span class=line><span class=cl><span class=s1>        - 10.0.2.1/24
</span></span></span><span class=line><span class=cl><span class=s1>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Disable <strong>dnsmasq</strong> conflicts with <strong>systemd-resolved</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano /etc/systemd/resolved.conf
</span></span><span class=line><span class=cl><span class=c1># Append DNSStubListener=no to the end of the file and save</span>
</span></span><span class=line><span class=cl>sudo systemctl restart systemd-resolved
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> dnsmasq
</span></span><span class=line><span class=cl>sudo systemctl restart dnsmasq
</span></span></code></pre></td></tr></table></div></div><ul><li>Setup the dhcp server</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano /etc/dhcp/dhcpd.conf
</span></span><span class=line><span class=cl><span class=c1># Add the following content to the configuration</span>
</span></span><span class=line><span class=cl>: <span class=s1>&#39;subnet 10.0.2.0 netmask 255.255.255.0 {
</span></span></span><span class=line><span class=cl><span class=s1>   option domain-name &#34;malware.wtf&#34;;
</span></span></span><span class=line><span class=cl><span class=s1>   default-lease-time 600;
</span></span></span><span class=line><span class=cl><span class=s1>   max-lease-time 7200;
</span></span></span><span class=line><span class=cl><span class=s1>   option routers 10.0.2.1;
</span></span></span><span class=line><span class=cl><span class=s1>   option subnet-mask 255.255.255.0;
</span></span></span><span class=line><span class=cl><span class=s1>   option broadcast-address 10.0.2.255;
</span></span></span><span class=line><span class=cl><span class=s1>   option domain-name-servers 10.0.2.1;
</span></span></span><span class=line><span class=cl><span class=s1>   range 10.0.2.2 10.0.2.254;
</span></span></span><span class=line><span class=cl><span class=s1>}&#39;</span>
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> isc-dhcp-server
</span></span><span class=line><span class=cl>sudo systemctl restart isc-dhcp-server
</span></span></code></pre></td></tr></table></div></div><ul><li>Browse to <strong>https://10.0.1.1</strong> and login with <strong>admin:pfsense</strong> and setup your own password for PFSense.<ul><li>Add firewall rules to block your local network, in my case it was to block everything from <strong>LAN net</strong> to <strong>192.168.0.1/24</strong>.</li><li>Apply the changes</li></ul></li><li>Setup internet forwarding</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE
</span></span><span class=line><span class=cl>sudo apt install iptables-persistent <span class=c1># Say yes to both prompts</span>
</span></span><span class=line><span class=cl>sudo nano /etc/sysctl.conf <span class=c1># Uncomment the line with net.ipv4.ip_forward=1</span>
</span></span><span class=line><span class=cl>sudo sysctl -w net.ipv4.ip_forward<span class=o>=</span><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Create a script to allow to you start your VPN</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano vpn.sh
</span></span><span class=line><span class=cl><span class=c1># Add the following contents and save</span>
</span></span><span class=line><span class=cl>: <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=s1>openvpn --daemon --config AirVPN_All-servers_UDP-443.ovpn
</span></span></span><span class=line><span class=cl><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>chmod +x vpn.sh
</span></span><span class=line><span class=cl>sudo ./vpn.sh
</span></span></code></pre></td></tr></table></div></div><ul><li>Setup TLS Decryption with MITMProxy</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install -y wireshark tshark <span class=c1># Say yes to non-super user packet capture</span>
</span></span><span class=line><span class=cl>sudo usermod -a -G wireshark <span class=nv>$USER</span>   <span class=c1># logout then login again</span>
</span></span><span class=line><span class=cl>wget https://snapshots.mitmproxy.org/8.1.0/mitmproxy-8.1.0-linux.tar.gz
</span></span><span class=line><span class=cl>tar -xzvf mitmproxy-8.1.0-linux.tar.gz
</span></span><span class=line><span class=cl>sudo mv mitmdump /usr/bin/
</span></span><span class=line><span class=cl>sudo mv mitmproxy /usr/bin/
</span></span><span class=line><span class=cl>sudo mv mitmweb /usr/bin/
</span></span><span class=line><span class=cl>wget https://gist.githubusercontent.com/c3rb3ru5d3d53c/d9eb9d752882fcc630d338a6b2461777/raw/f56cbef4b98c7bad8f265534eabf696923b649a2/mitmpcap
</span></span><span class=line><span class=cl>chmod +x mitmpcap
</span></span><span class=line><span class=cl>sudo mv mitmpcap /usr/bin/
</span></span><span class=line><span class=cl>wget https://gist.githubusercontent.com/c3rb3ru5d3d53c/3bc8041a182467ccae0207394c1e16b3/raw/33bf201da721ae8f8dc057480221a3c6612e7c11/mitmhttp
</span></span><span class=line><span class=cl>chmod +x mitmhttp
</span></span><span class=line><span class=cl>sudo mv mitmhttp /usr/bin/
</span></span><span class=line><span class=cl>sudo mkdir /root/.mitmproxy
</span></span></code></pre></td></tr></table></div></div><p>Once completed, you should be able to reboot and run <strong>sudo ./vpn.sh</strong> to get connected to the internet. <em>NOTE: The internet will not work on the Analysis LAN unless you have VPN enabled as we set the internet to be forwarded through <strong>tun0</strong> for <strong>openvpn</strong>.</em> This is a good thing, this means it will force you to use an anonymous VPN and reduce risk of leaking your actual IP address.</p><h3 id=create-windows-vm>Create Windows VM</h3><p>This VM will sit on the Analysis LAN, its main purpose is to dynamically analyze malware by executing it. This includes debugging, tracing API calls and more.</p><p><em>NOTE: With a Windows VM it is very important to ensure your boot drive is using the VirtIO drivers.</em></p><iframe width=560 height=315 src=https://www.youtube.com/embed/xc6hviPzMK0 title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><ul><li>Download <a href=https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso target=_blank rel="noopener noreffer">VirtIO ISO</a></li><li>Create disk image</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qemu-img create -f qcow2 windows.qcow2 128G
</span></span></code></pre></td></tr></table></div></div><ul><li>Create a new virtual machine<ul><li>Import existing disk image</li><li>Select <strong>windows.qcow2</strong> as the storage path</li><li>Select Windows as the OS</li><li>Name: <strong>windows</strong></li><li>Customize configuration before install</li><li>Set first NIC to <strong>vmbr1</strong> (Analysis LAN)</li><li>Add Hardware -> Storage -> CDROM Device-> Manage -> Windows ISO Image</li><li>Add Hardware -> Storage CDROM Device -> Manage -> VirtIO ISO</li><li>Boot Options -> Set CDROM device for Windows ISO to boot first</li><li>Remove the SATA Disk and replace with one for VirtIO pointing to <strong>windows.qcow2</strong></li><li>Start installation</li></ul></li><li>During the Windows install the VirtIO disk will not show unless you browse to the VirtIO ISO and select the folder with the drivers for your version of Windows. Once completed, you can proceed with the installation.</li><li>Once Windows is installed, open Device Manager and identify all the drivers with question marks and update them using the VirtIO ISO CDROM.</li><li>Download and install <a href=https://www.spice-space.org/download/windows/spice-guest-tools/spice-guest-tools-latest.exe target=_blank rel="noopener noreffer">Spice Guest Tools</a></li><li>Reboot the VM</li></ul><p>If you are unable to boot using the VirtIO driver, try the following troubleshooting steps:</p><ul><li>Open an elevated command prompt and set the VM to boot into safe mode by typing<ul><li><strong><em>bcdedit /set {current} safeboot minimal</em></strong></li></ul></li><li>shut-down the VM and change the boot device type to virtio</li><li>boot the VM. It will enter in safe mode.</li><li>in the booted VM reset the bcdedit settings to allow the machine to boot into the Normal mode by typing (in an elevated command prompt again):<ul><li><strong><em>bcdedit /deletevalue {current} safeboot</em></strong></li></ul></li></ul><p>Reference: <a href=https://superuser.com/questions/1057959/windows-10-in-kvm-change-boot-disk-to-virtio target=_blank rel="noopener noreffer">Windows 10 in KVM: change boot disk to Virtio</a></p><p>Once you have completed all necessary steps, it is recommended to remove the CDROM drive for the VirtIO drivers.</p><h2 id=installing-tls-decryption-certificates>Installing TLS Decryption Certificates</h2><p>This section of the guide will discuss how to get TLS decryption working on your Remnux VM so you can transparently decrypt TLS and capture secrets and pcaps from the analysis network as long as the devices have the root CA installed.</p><iframe width=560 height=315 src=https://www.youtube.com/embed/CAzEG4QwQkk title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><ul><li>On your Remnux machine do the following commands</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mitmhttp -i &lt;analysis-network-interface&gt; --enable
</span></span><span class=line><span class=cl>mitmproxy --mode transparent --listen-host 0.0.0.0 --listen-port <span class=m>8080</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>On your Windows VM open a browser and go to <strong>mitm.it</strong> then follow either the Manual or Automated install instructions<ul><li>Manual Install<ul><li>On the webpage download the certificate for Windows</li><li>Double click the P12 file to start the import wizard</li><li>Select a certificate store location. This determines who will trust the certificate – only the current Windows user or everyone on the machine. Click Next.</li><li>Click Next again</li><li>Leave Password blank and click Next</li><li>Select Place all certificates in the following store, then click Browse, and select Trusted Root Certification Authorities. Click OK and Next</li><li>Click Finish</li><li>Click Yes to confirm the warning dialog.</li></ul></li><li>Automated Install<ul><li><strong>certutil.exe -addstore root mitmproxy-ca-cert.cer</strong></li></ul></li><li>In your browser visit <a href=https://example.com target=_blank rel="noopener noreffer">https://example.com</a> to verify a successful decryption in the mitmproxy interface</li></ul></li></ul><p>If the above steps were successful, you can now use the tool mitmpcap to view traffic live with mitmproxy but also use it to capture TLS secrets and a pcap for analysis later.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mitmpcap -i enp7s0 -w dump.pcap -m transparent -p <span class=m>8080</span> -s secrets.txt -v <span class=m>1</span> -f libpcap
</span></span></code></pre></td></tr></table></div></div><p>Once you have finished your capture, press <strong>Q</strong> then <strong>Y</strong> to exit mitmproxy. You should then notice you have the files <strong>dump.pcap</strong> and <strong>secrets.txt</strong>. The following steps will show you how to use Wireshark to analyze your capture.</p><ul><li>Open <strong>dump.pcap</strong> with Wireshark</li><li>Edit -> Preferences -> Protocols -> TLS -> (Pre)-Master-Secret log filename Browse -> select <strong>secrets.txt</strong></li><li>In the filter bar type <strong>http</strong> and press <strong>Enter</strong></li><li>You should now have decrypted TLS traffic</li></ul><p>Once you have completed capturing your traffic and no longer wish to perform interception, disable the redirection by executing the following.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mitmhttp -i &lt;analysis-network-interface&gt; --disable
</span></span></code></pre></td></tr></table></div></div><h2 id=install-malware-analysis-tools>Install Malware Analysis Tools</h2><p>Once you have completed the networking and VM creation, you can install your favorite malware analysis tools!</p><p>You can get a list of my favorite tools <a href=/docs/malware-analysis-tools/ rel>here</a>.</p><h2 id=establishing-a-clean-environment>Establishing a Clean Environment</h2><p>Once you have completed installing your favorite tools, establish a clean environment by taking snapshots of every VM. This will ensure you can go back to those clean states after you have completed an analysis.</p><h2 id=sharing-files-between-host-and-remnux-vm>Sharing Files Between Host and Remnux VM</h2><p>Sometimes we wish to move files that are safe from our Remnux VM to our host machine. To do this, we can use the file system pass-through in KVM. Please note, it is not recommended to have your host and guest tied together at all times, to reduce your risk only mount this when needed and unmount when done.</p><ul><li>Memory<ul><li>Enable Shared Memory (checkmark)</li></ul></li><li>Add Hardware</li><li>Filesytem hostfs<ul><li>Driver -> virtiofs</li><li>Source path -> Browse Local -> Select Source Folder to Share</li><li>Target path -> hostfs</li><li>XML Tab -> under the <em>filesystem</em> tag put <em>accessmode=passthrough</em>
Example XML:</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;filesystem</span> <span class=na>type=</span><span class=s>&#34;mount&#34;</span> <span class=na>accessmode=</span><span class=s>&#34;passthrough&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;driver</span> <span class=na>type=</span><span class=s>&#34;virtiofs&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;binary</span> <span class=na>path=</span><span class=s>&#34;/usr/lib/qemu/virtiofsd&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;source</span> <span class=na>dir=</span><span class=s>&#34;/home/&lt;username&gt;/analysis&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;target</span> <span class=na>dir=</span><span class=s>&#34;hostfs&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;alias</span> <span class=na>name=</span><span class=s>&#34;fs0&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;address</span> <span class=na>type=</span><span class=s>&#34;pci&#34;</span> <span class=na>domain=</span><span class=s>&#34;0x0000&#34;</span> <span class=na>bus=</span><span class=s>&#34;0x08&#34;</span> <span class=na>slot=</span><span class=s>&#34;0x00&#34;</span> <span class=na>function=</span><span class=s>&#34;0x0&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/filesystem&gt;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Boot Remnux VM</li><li>Mount the folder</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/
</span></span><span class=line><span class=cl>mkdir hostfs
</span></span><span class=line><span class=cl>sudo mount -t virtiofs hostfs hostfs/
</span></span><span class=line><span class=cl><span class=c1># do things here</span>
</span></span><span class=line><span class=cl>sudo umount hostfs/
</span></span></code></pre></td></tr></table></div></div><h2 id=forwarding-ports>Forwarding Ports</h2><p>Using <code>virt-manager</code> you can edit XML by enabling <code>Edit->Preferences->General->Enable XML editing</code>.</p><p>Using this, ensure the <code>&lt;domain></code> XML is <code>&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'></code>.</p><h3 id=host-to-guest>Host to Guest</h3><p>To forward ports from your host machine to your guest machine, you can use QEMU command-line with <code>-netdev</code> and <code>-device</code>.</p><p>The <code>id</code> and <code>netdev</code> options must be the same unique string.</p><p>The <code>guestfwd</code> option by default uses the <code>net</code> option of <code>10.0.2.0/24</code> for the subnet.</p><p>To change this we set our own <code>net</code> option to <code>10.0.3.0/24</code>, using the IP address <code>10.0.3.1</code>.</p><p>We are forwarding, in this case, 11434 from the host machine, to <code>10.0.3.1:11434</code> on a guest interface.</p><p>The XML for this is provided below.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;qemu:commandline&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;qemu:arg</span> <span class=na>value=</span><span class=s>&#39;-netdev&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;qemu:arg</span> <span class=na>value=</span><span class=s>&#39;user,id=hosttoguest,net=10.0.3.0/24,guestfwd=tcp:10.0.3.1:11434-tcp:127.0.0.1:11434&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;qemu:arg</span> <span class=na>value=</span><span class=s>&#39;-device&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;qemu:arg</span> <span class=na>value=</span><span class=s>&#39;rtl8139,netdev=hosttoguest&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/qemu:commandline&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>This example, uses the <code>ollama</code> port for working with LLMs, now we can access the port by doing <code>curl http://10.0.3.1:11434</code>.</p><p>This usecase is for those who may want to use LLMs for static reversing but do not have two available graphics cards for PCI passthrough.</p><blockquote><p>NOTE: It is important to know that forwarding ports to your host machine can pose additional risks</p></blockquote><h3 id=guest-to-host>Guest to Host</h3><p>Similar to forwarding ports from the host machine to the guest machine, we use the <code>netdev</code> option.</p><p>However, this time we are forwarding port <code>2222</code> on the host to <code>22</code> on the guest.</p><p>If SSH is enabled on the guest machine, from your host machine you can do <code>ssh -p 2222 username@127.0.0.1</code> to get a shell.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;qemu:commandline&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;qemu:arg</span> <span class=na>value=</span><span class=s>&#39;-netdev&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;qemu:arg</span> <span class=na>value=</span><span class=s>&#39;user,id=guesttohost,net=10.0.3.0/24,hostfwd=tcp::2222-:22&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;qemu:arg</span> <span class=na>value=</span><span class=s>&#39;-device&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;qemu:arg</span> <span class=na>value=</span><span class=s>&#39;rtl8139,netdev=guesttohost&#39;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/qemu:commandline&gt;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>NOTE: It is important to note that accessing your guest machines directly using additional applications on your host can pose additional risks.</p></blockquote><h2 id=workflow>Workflow</h2><p>When working with malware it is important to establish a general workflow, please refer to my guide <a href=/documents/malware-analysis-reversing-workflow/ rel>here</a>.</p><h2 id=conclusion>Conclusion</h2><p>Once you have the PFSense and Remnux VMs setup, you can create additional VMs on your Analysis LAN to suit your needs.</p><p>Creating a malware lab using KVM can be a daunting task for beginners compared to using VMWare Workstation or VirtualBox. However, it can benefit your lab in the following ways.</p><ul><li>Access to source code you can edit to make your VMs super stealthy</li><li>CPU Emulated VMs (MIPS, ARM, etc.) for IoT malware</li><li>PCI pass through of hardware</li></ul><p>Again I cannot recommend KVM enough, it is great for malware analysis!</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-06-18</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://c3rb3r3u5d3d53c.github.io/2022/06/kvm-malware-lab/ data-title="KVM Malware Lab Guide" data-via=c3rb3ru5d3d53c data-hashtags=Cheatsheet><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://c3rb3r3u5d3d53c.github.io/2022/06/kvm-malware-lab/ data-hashtag=Cheatsheet><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://c3rb3r3u5d3d53c.github.io/2022/06/kvm-malware-lab/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://c3rb3r3u5d3d53c.github.io/2022/06/kvm-malware-lab/ data-title="KVM Malware Lab Guide"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://c3rb3r3u5d3d53c.github.io/2022/06/kvm-malware-lab/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://c3rb3r3u5d3d53c.github.io/2022/06/kvm-malware-lab/ data-title="KVM Malware Lab Guide"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://c3rb3r3u5d3d53c.github.io/2022/06/kvm-malware-lab/ data-title="KVM Malware Lab Guide"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/cheatsheet/>Cheatsheet</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2022/06/malware-analysis-tools/ class=prev rel=prev title="Malware Analysis Tool List"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Malware Analysis Tool List</a>
<a href=/2022/06/career/ class=next rel=next title="From Nothing to a Career in Cyber">From Nothing to a Career in Cyber<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://c3rb3ru5d3d53c.github.io target=_blank>c3rb3r3u5d3d53c</a></span>&nbsp;|&nbsp;<span class=license><a rel="This is free and unencumbered software released into the public domain." href=https://unlicense.org target=_blank>The Unlicense</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},data:{"id-1":"Malware Hell","id-2":"Malware Hell"},lightgallery:!0,search:{algoliaAppID:"",algoliaIndex:"",algoliaSearchKey:"",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"},twemoji:!0,typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:100}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>